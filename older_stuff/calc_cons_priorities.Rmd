---
title: 'Calculate conservation priorities'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here::here('common_fxns.R'))

dir_bd_anx <- '~/git-annex/bd_chi' ### this is on git-annex in home/ohara
dir_cons <- 'layers/cons_priorities'
```

# Summary

Following Selig et al. 2014, estimate conservation priorities based on biodiversity metrics and threats.

* Identify top 10% and bottom 10% of cells based on cumulative impacts.
* Identify top 5% of cells based on species richness and range-rarity species richness, separately within EEZ and ABNJ.
* New: Identify top 5% and bottom 5% of cells based on mean biodiversity risk.
    * when intersecting with species richness, maybe up thresholds on both to 10%?
* New: Identify top 10% and bottom 10% of cells based on trends in CHI.
    * when intersecting with CHI, maybe up thresholds on both to 20%?

Intersect these various layers and see what magic occurs.

# Data Sources

Halpern et al. 2019, O'Hara et al. 2019

# Methods

## Gather prepared rasters

The connservation priorities layers are all created prior to this script.

```{r}
cons_layers <- list.files('layers/cons_priorities', 
                          pattern = '50km.tif$', full.names = TRUE)

### set names to have an easy handle on the layers
cons_stack <- raster::stack(cons_layers) %>%
  setNames(basename(cons_layers) %>% str_replace('_thresh.*', ''))
# names(cons_stack)
# CHI layers:     "chi",    "chi_trend" 
# spp richness:   "nspp",   "sr_rr"      
# mean risk:      "risk",   "risk_rr"   
# pct threatened: "threat", "threat_rr"
```

## Basic analysis: impacts to biodiversity

To approximate Selig et al. 2014, compare the top 10% and bottom 10% of cumulative human impacts to the top 5% of species richness and top 5% of range-rarity-weighted species richness.  We can also look at proportional range rarity, though this layer would need to be prepared here as it was not created for the BD risk project.

```{r prep layers}
chi_top <- cons_stack[['chi']]
values(chi_top)[abs(values(chi_top)) < 0.89] <- NA
### use abs value so we keep both -0.9 and +0.9
names(chi_top) <- 'chi_top10%'

chi_btm <- cons_stack[['chi']]
values(chi_btm)[abs(values(chi_btm)) > 0.11] <- NA
### use abs value so we keep both -0.1 and +0.1
names(chi_btm) <- 'chi_btm10%'

sr_top <- cons_stack[['nspp']]
values(sr_top)[abs(values(sr_top)) < 0.89] <- NA
names(sr_top) <- 'sr_top5%'

sr_rr_top <- cons_stack[['sr_rr']]
values(sr_rr_top)[abs(values(sr_rr_top)) < 0.89] <- NA
names(sr_rr_top) <- 'rr-sr_top5%'

```

```{r}
cross_layers <- function(chi_rast, bd_rast) {
  cross_rast <- mask(chi_rast, bd_rast)
  
  ### normalize, keeping +/-
  cross_rast <- cross_rast / abs(cross_rast)
  
  names(cross_rast) <- paste0(names(chi_rast), ' x ', names(bd_rast)) %>%
    str_replace_all('[^a-z0-9]+', '_')
  return(cross_rast)
}

chi_top_sr_top    <- cross_layers(chi_top, sr_top)
chi_btm_sr_top    <- cross_layers(chi_btm, sr_top)
chi_top_sr_rr_top <- cross_layers(chi_top, sr_rr_top)
chi_btm_sr_rr_top <- cross_layers(chi_btm, sr_rr_top)
```

``` {r}
chi_t_sr_df <- rasterToPoints(chi_top_sr_top) %>%
  as.data.frame() %>%
  setNames(c('x', 'y', 'val'))
chi_b_sr_df <- rasterToPoints(chi_btm_sr_top) %>%
  as.data.frame() %>%
  setNames(c('x', 'y', 'val'))
chi_t_sr_rr_df <- rasterToPoints(chi_top_sr_rr_top) %>%
  as.data.frame() %>%
  setNames(c('x', 'y', 'val'))
chi_b_sr_rr_df <- rasterToPoints(chi_btm_sr_rr_top) %>%
  as.data.frame() %>%
  setNames(c('x', 'y', 'val'))

ocean_df <- raster('_spatial/ocean_area_rast.tif') %>%
  aggregate(5) %>%
  rasterToPoints() %>%
  as.data.frame()

ggplot(ocean_df, aes(x, y)) +
  ggtheme_map() +
  geom_raster(fill = 'grey90', alpha = .5) +
  geom_raster(data = chi_t_sr_df, aes(fill = val + 2)) +
  geom_raster(data = chi_b_sr_df, aes(fill = val - 2)) +
  scale_fill_distiller(palette = 'RdYlBu') +
  labs(title = 'sr', fill = 'class')

ggplot(ocean_df, aes(x, y)) +
  ggtheme_map() +
  geom_raster(fill = 'grey90', alpha = .5) +
  geom_raster(data = chi_t_sr_rr_df, aes(fill = val + 2)) +
  geom_raster(data = chi_b_sr_rr_df, aes(fill = val - 2)) +
  scale_fill_distiller(palette = 'RdYlBu') +
  labs(title = 'rr sr',
       fill = 'class')

```

