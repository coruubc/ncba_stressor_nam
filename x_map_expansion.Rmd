---
title: 'Map impact trends for all impacted species'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

reload <- FALSE
```


# Summary

Create a species richness map for threatened marine species.

For each time series of impacts, calculate a pixel-by-pixel trend.  The trend will represent the per-pixel annual change in the number of impacted species present.

This is all done at the level of cumulative impact category, not individual stressors.

# Methods

## Get species richness map

Set up the dataframe of species to include.  By taxon, load all species range maps, smash down to taxon-level species richness; then combine these for a total species richness.

```{r Identify species in this assessment}

spp_incl <- get_incl_spp()

spp_sens <- spp_incl %>%
  filter(!is.na(stressor))

# spp_incl$iucn_sid %>% n_distinct()
# spp_incl %>% filter(!is.na(stressor)) %>% .$iucn_sid %>% n_distinct()
### 1006 if we limit to just sensitive spp, 1273 if we include all
### spp that are mapped/threatened/comp assessed
```

```{r get rasters}
cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))
spp_rich_rast <- raster(here('_output/rasters/n_spp_map.tif'))

plot(spp_rich_rast, main = 'Species richness')

```


## Calculate trend

let's try calculating trend using `lm()` in a cell_id dataframe.
```{r define functions}
get_impact_df <- function(map_files) {
  impact_stack <- stack(map_files)
    
  impact_df <- data.frame(values(impact_stack)) %>%
    mutate(cell_id = values(cell_id_rast),
           ocean_a = values(ocean_a_rast)) %>%
    filter(!is.na(ocean_a)) %>%
    gather(year, value, -cell_id, -ocean_a) %>%
    mutate(year = as.integer(str_extract(year, '[0-9]{4}')),
           value = ifelse(is.na(value), 0, value)) %>%
    select(-ocean_a)
  
  return(impact_df)
}

calc_trend_chunk <- function(df) {
  trend_df <- df %>%
    group_by(cell_id) %>%
    do(mdl = lm(value ~ year, data = .)) %>%
    mutate(adj_r2 = summary(mdl)$adj.r.squared) %>%
    broom::tidy(mdl)
}

calc_trends <- function(impact_df, 
                        tmpfile_stem,
                        chunk_size = 50000) {
  
  cell_id_vec <- impact_df$cell_id %>%
    unique()
  n_chunks <- ceiling(length(cell_id_vec) / chunk_size)
  cell_index <- rep(1:n_chunks, each = chunk_size, 
                    length.out = length(cell_id_vec))
  
  # system.time({
  x <- parallel::mclapply(1:n_chunks,
      FUN = function(i) {
      # i <- 30
      tmp_file <- sprintf(tmpfile_stem, i)
      
      if(!file.exists(tmp_file)) {
        ids <- cell_id_vec[cell_index == i]
        tmp_df <- impact_df %>%
          filter(cell_id %in% ids) %>%
          calc_trend_chunk()
        
        write_csv(tmp_df, tmp_file)

      }
    return(NULL)
    }, mc.cores = 35)
  # })  
}

gather_tmp_files <- function(tmpfile_stem) {
  pattern <- basename(tmpfile_stem) %>%
    str_replace('%s', '.+')
  tmp_files <- list.files(dirname(tmpfile_stem),
                          pattern = pattern,
                          full.names = TRUE)
  tmp_df <- parallel::mclapply(tmp_files,
                               FUN = read_csv,
                               col_types = cols(.default = 'd', 'term' = 'c'),
                               mc.cores = 20) %>%
    bind_rows() %>%
    filter(term == 'year') %>%
    select(cell_id, trend = estimate, p.value)
  
  return(tmp_df)
}
```

``` {r}
file_stem <- here('_output/rasters/impact_map_%s_%s.tif')
stressors <- c('fishing', 'land-based', 'ocean', 'climate', 'all')
years <- 2003:2013

tmp_dir <- file.path(dir_bd_anx, 'tmp')
# unlink(file.path(tmp_dir, '*.*'))

for(j in seq_along(stressors)) {
  # j <- 5
  str <- stressors[j]
  message('Processing trends for ', str)
  map_files <- sprintf(file_stem, years, str)
  
  impact_df <- get_impact_df(map_files)
  
  tmpfile_stem <- file.path(tmp_dir, paste0('trend_', str, '_chunk_%s.csv'))
  
  x <- calc_trends(impact_df, tmpfile_stem, chunk_size = 50000)

}
```

```{r}

for(str in stressors) {
  # str <- stressors[1]
  message('Creating rasters for ', str)
  tmpfile_stem <- file.path(tmp_dir, paste0('trend_', str, '_chunk_%s.csv'))
  trend_df <- gather_tmp_files(tmpfile_stem)
  
  trend_rast <- map_to_rast(trend_df, cell_val = 'trend')
  
  
  pval_rast <- map_to_rast(trend_df, cell_val = 'p.value')
  sig_rast <- pval_rast
  values(sig_rast)[values(sig_rast) > 0.05] <- NA

  sig_trend_rast <- mask(trend_rast / spp_rich_rast, sig_rast)
  plot(sig_trend_rast, 
       col = hcl.colors(n = 100, palette = 'RdYlGn', rev = TRUE),
       main = paste0('Trend (%): ', str))
  
  out_filestem <- file.path(here('_output/rasters/trend_%s_%s.tif'))
  writeRaster(trend_rast, sprintf(out_filestem, str, 'value'), overwrite = TRUE)
  writeRaster(pval_rast, sprintf(out_filestem, str, 'p_val'), overwrite = TRUE)
}
```

