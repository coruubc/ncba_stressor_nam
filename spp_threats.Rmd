---
title: 'Spp threats by narrative and category'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)


source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

dir_git <- here::here()

### goal specific folders and info
dir_setup   <- file.path(dir_git, '_setup')
dir_o_anx <- file.path(dir_O, 'git-annex/bd_chi')

source(file.path(dir_setup, 'common_fxns.R'))

```

# Summary

Examine threats to marine species as determined by IUCN threat classifications and text dismemberment of IUCN species narratives.

# Data Sources

### IUCN Red List

# Methods

## Get IUCN threat lists for all available IUCN marine spp

``` {r}

spp_threats_file <- file.path(dir_git, '_data/iucn_spp_threats_2018-1.csv')

spp_info <- read_csv(file.path(dir_git, '_data', 'iucn_risk_current_2018-1.csv'))

if(!file.exists(spp_threats_file)) {
  
  spp_ids <- spp_info$iucn_sid
  
  threat_url <- 'http://apiv3.iucnredlist.org/api/v3/threats/species/id/%s?token=%s'
  
  ptm <- system.time({
    spp_threats <- mc_get_from_api(threat_url, spp_ids, api_key, cores = 12)
  })
  ptm[3]
  
  spp_threats <- spp_threats %>%
    mutate(#id = ifelse(!is.na(api_error), param_id, id),
           score_num = as.integer(str_extract(score, '[0-9]+'))) %>%
    select(-param_id, -api_error, iucn_sid = id)
  
  write_csv(spp_threats, spp_threats_file)
}
```

``` {r}

spp_threats <- read_csv(file.path(spp_threats_file)) %>%
  distinct() %>%
  mutate(impact = str_replace(score, ':.*', ''))
  
threat_class <- read_csv(file.path(dir_git, '_raw/iucn_threat_class.csv'))

spp_threat_cats <- spp_threats %>%
  group_by(code, timing, impact) %>%
  summarize(n_spp = n()) %>%
  left_join(threat_class, by = 'code') %>%
  mutate(cat = str_extract(desc, '.+?(?=:)'),
         cat_code = str_extract(code, '^[0-9]+') %>% as.integer()) %>%
  arrange(cat_code) %>%
  filter(!is.na(cat_code))
  
cats <- spp_threat_cats$cat %>% unique()

for(threat_cat in cats) {
  ### threat_cat <- cats[1]
  thr_cat_df <- spp_threat_cats %>%
    filter(cat == threat_cat) %>%
    mutate(desc = str_replace(desc, '^.+: ', ''))
  
  cat_plot <- ggplot(thr_cat_df, aes(x = desc, y = n_spp, fill = impact)) +
    ggtheme_plot() +
    theme(axis.title.y = element_blank()) +
    geom_bar(stat = 'identity') +
    coord_flip() +
    labs(title = threat_cat,
         y = 'number of affected species')
  
  print(cat_plot)
}
```

## Get IUCN narratives for all available IUCN marine spp

From the full IUCN species list, send each IUCN species ID into the API to get the narrative listed for that species. 

``` {r determine_spp_narrs}

spp_info <- read_csv(file.path(dir_git, '_data', 'iucn_risk_current_2018-1.csv'))

spp_narr_from_api_file <- file.path(dir_o_anx, 
  sprintf('iucn/spp_narr_from_api_%s.csv', api_version))
reload <- FALSE

if(!file.exists(spp_narr_from_api_file) | reload) {
  
  cat_msg('Using API to determine species narrative from full species info list')
  
  spp_ids_all <- spp_info %>%
    .$iucn_sid
  
  spp_narr_url <- 'http://apiv3.iucnredlist.org/api/v3/species/narrative/id/%s?token=%s'
  
  ### Breaking this into chunks...
  ### 500 spp takes 184 seconds; at that rate, 87851 species should take 
  ###   about 9 hrs.  Each chunk will save to tmp for later combining.

  chunk_size <- 2000
  n_chunks <- ceiling(length(spp_ids_all)/chunk_size)
  
  if(!dir.exists(file.path(dir_o_anx, 'tmp'))) {
    dir.create(file.path(dir_o_anx, 'tmp'))
  } ### unlink(file.path(dir_o_anx, 'tmp'), force = TRUE, recursive = TRUE)

  
  for(j in 1:n_chunks) { 
    ### j <- 1
    spp_index <- c( ((j - 1) * chunk_size + 1) : min((j * chunk_size), length(spp_ids_all)) )
    chunk_file <- file.path(dir_o_anx, 'tmp', 
                    sprintf('spp_narr_chunk_%s_%s.csv', 
                            min(spp_index), max(spp_index)))

    if(!file.exists(chunk_file)) {
      cat_msg('Getting narrative info for species ', min(spp_index), ' to ', max(spp_index))
      
      spp_ids_chunk <- spp_ids_all[spp_index]
      spp_narr_chunk <- mc_get_from_api(spp_narr_url, spp_ids_chunk, api_key, cores = 12, delay = .5)
      cat_msg('... found ', nrow(spp_narr_chunk), ' narrative rows for these species')
      
      write_csv(spp_narr_chunk, chunk_file)
      
    } else {
      
      cat_msg('Chunk file ', chunk_file, ' already exists; skipping these spp')
      
    }
  }
  
  ### fields: 
  ### id | code | habitat | suitability | season | majorimportance

  spp_narr_chunk_files <- list.files(file.path(dir_o_anx, 'tmp'), 
                                    pattern = 'spp_narr_chunk', 
                                    full.names = TRUE)
  
  spp_narr_df <- lapply(spp_narr_chunk_files, FUN = function(x) read_csv(x)) %>%
    bind_rows() %>%
    rename(iucn_sid = species_id) %>%
    mutate(iucn_sid = ifelse(is.na(iucn_sid), param_id, iucn_sid)) %>%
    arrange(iucn_sid)
  
  spp_errors <- spp_narr_df %>%
    filter(!is.na(api_error) & api_error != 'no data.frame') %>%
    .$iucn_sid
  ### all these errors are due to returning a zero-length list instead of a data.frame

  write_csv(spp_narr_df, spp_narr_from_api_file)
  
} else {
  
  cat_msg('File of species narratives from API exists: \n  ', spp_narr_from_api_file)

}


```

## Check for bycatch and gear instances

```{r}

spp_narr_df <- read_csv(spp_narr_from_api_file) %>%
  select(-name, -param_id, -api_error)

gear_str <- c('gill.?net', 'long.?line', 'trawl', 'seine', 'by.?catch')

gear_narr_df <- spp_narr_df %>%
  gather(dimension, text, -iucn_sid) %>%
  # mutate(text_short = str_split(text, '\\. ')) %>%
  # unnest(text_short) %>%
  filter(str_detect(text, paste0(gear_str, collapse = '|')))

gear_narr_class <- gear_narr_df %>%
  group_by(iucn_sid, text, dimension) %>%
  mutate(bycatch_count  = str_count(text, 'by.?catch'),
         longline_count = str_count(text, 'long.?line'),
         trawl_count    = str_count(text, 'trawl'),
         seine_count    = str_count(text, 'seine'),
         gillnet_count  = str_count(text, 'gill.?net'))

write_csv(gear_narr_class, 'int/gear_narr_classified.csv')
```

