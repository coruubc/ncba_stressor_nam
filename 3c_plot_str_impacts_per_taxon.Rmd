---
title: 'Plot species stressor impacts'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(widyr)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

dir_spp_intsx <- file.path(dir_bd_anx, 'spp_str_rasts')
```


# Summary

For each species and then taxon, count co-occurrence of impacts by pairwise comparison.  Do this only for 2013: this will tell us the impacts in the most recent year.

# Methods

* Read in data of impacts per cell per spp
* For each spp, count the pairwise cooccurrences of pairs of stressors, weighted by ocean area
* For each spp, divide by the spp range to get % impacted in each pair
* Combine to taxon and then find mean/sd of each cooccurrence.

```{r}
read_intsx <- function(f) {
  str <- dirname(f) %>% basename()
  z <- read_csv(f, col_types = 'ii') %>%
    filter(year == 2013) %>%
    select(-year)
  ### Check for no-impact results
  if(nrow(z) == 0) z <- data.frame(cell_id = NA)
  
  ### append stressor name
  z <- z %>%
    mutate(stressor = str)
  
  return(z)
}

process_pairwise <- function(id, files, level = 'str') {
  ### gathers all spp-str intersections, performs a pairwise count weighted
  ### by the ocean area of each cell.  The result is a dataframe with the
  ### area (and proportion of range) of each overlapping spp-str combination.
  ### If level == 'cat' then instead of stressor level pairwise it will be
  ### calculated at the category level.
  message('Processing ', id)
  
  spp_range <- get_spp_range(id)
  spp_intsx_files <- files %>%
    filter(iucn_sid == id) %>%
    .$f
  
  spp_intsx <- lapply(spp_intsx_files, # f <- spp_intsx_files[2]
                      FUN = read_intsx) %>%
    bind_rows() %>%
    mutate(iucn_sid = id) %>%
    filter(!is.na(cell_id))
  
  if(nrow(spp_intsx) == 0) {
    message('zero-length dataframe: no intersections')
    null_df <- data.frame(iucn_sid = id)
    return(null_df)
  }
  
  spp_intsx_area <- spp_intsx %>%
    dt_join(ocean_a_df, by = 'cell_id', type = 'left')
  
  if(level == 'str') {
    spp_pairwise <- pairwise_count(spp_intsx_area, item = stressor, feature = cell_id,
                                   wt = ocean_area_km2,
                                   diag = TRUE) %>%
      rename(str1 = item1, str2 = item2) %>%
      mutate(pct = n / spp_range$range_km2,
             iucn_sid = id)
  } else if(level == 'cat') {
    ### join the categories, filter to any impact within the category (by removing
    ### stressor name and then distinct())
    spp_intsx_area_cat <- spp_intsx_area %>%
      left_join(get_str_cats(), by = 'stressor') %>%
      select(-stressor) %>%
      distinct()
    spp_pairwise <- pairwise_count(spp_intsx_area_cat, item = category, feature = cell_id,
                                   wt = ocean_area_km2,
                                   diag = TRUE) %>%
      rename(cat1 = item1, cat2 = item2) %>%
      mutate(pct = n / spp_range$range_km2,
             iucn_sid = id)
    
  }
  
  return(spp_pairwise)
}
```

```{r}
ocean_a_rast <- raster('_spatial/ocean_area_mol.tif')
cell_a_km2 <- res(ocean_a_rast)[1]^2 / 1e6
ocean_a_df <- data.frame(cell_id = 1:ncell(ocean_a_rast),
                         ocean_prop = values(ocean_a_rast)) %>%
  mutate(ocean_area_km2 = ocean_prop * cell_a_km2) %>%
  filter(!is.na(ocean_prop))
```

### Pairwise impacts across all threatened/near-threatened spp

```{r}

spp_incl <- get_incl_spp() %>%
  filter(!is.na(stressor))
spp_ids <- spp_incl$iucn_sid %>% 
  unique() %>% sort()

str_order <- get_str_cats() %>%
  arrange(category, stressor) %>%
  .$stressor

all_intsx_files <- data.frame(
  f = list.files(dir_spp_intsx,
                 recursive = TRUE, full.names = TRUE)) %>%
  mutate(iucn_sid = str_extract(basename(f), '[0-9]+') %>%
           as.integer(),
         str = basename(dirname(f))) %>%
  filter(iucn_sid %in% spp_ids)

pairwise_list <- parallel::mclapply(spp_ids, # id <- spp_ids[1]
                        FUN = function(x, f) {
                          process_pairwise(id = x, files = all_intsx_files, level = 'str')
                        },
                        mc.cores = 16)

pairwise_df <- bind_rows(pairwise_list)

pairwise_summary <- pairwise_df %>%
  filter(!is.na(pct)) %>%
  group_by(str1, str2) %>%
  summarize(n_spp = n_distinct(iucn_sid),
            mean_pct = mean(pct),
            sd_pct = sd(pct))

  mtxplot_df <- pairwise_summary %>%
    complete(str1 = str_order, str2 = str_order) %>%
    mutate(str1 = factor(str1, levels = str_order),
           str2 = factor(str2, levels = str_order)) %>%
    filter(as.integer(str1) >= as.integer(str2)) %>%
    mutate(str1 = fct_rev(str1))
 
  p <- ggplot(mtxplot_df, aes(x = str1, y = str2)) +
    ggtheme_plot() +
    geom_abline(intercept = 15, slope = -1, color = 'red', alpha = .5) +
    geom_point(aes(size = n_spp, color = mean_pct)) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1),
          axis.title = element_blank()) +
    scale_color_viridis_c() +
  labs(title = 'all species')

```

### Pairwise impacts by taxonomic group by category

```{r}

spp_taxa <- spp_incl %>%
  left_join(get_spp_taxon(), by = c('iucn_sid', 'assess_gp')) %>%
  rename(taxon = rank)

cat_order <- c('fishing', 'land-based', 'ocean', 'climate')

taxa <- spp_taxa$desc %>% unique()

for(t in taxa) { ### t <- taxa[3]
  message('processing ', t)
  
  spp_ids <- spp_taxa %>%
    filter(desc == t) %>%
    .$iucn_sid %>%
    unique() %>% sort()
  
  taxon_intsx_files <- data.frame(
    f = list.files(dir_spp_intsx,
                   recursive = TRUE, full.names = TRUE)) %>%
    mutate(iucn_sid = str_extract(basename(f), '[0-9]+') %>%
             as.integer(),
           str = basename(dirname(f))) %>%
    filter(iucn_sid %in% spp_ids)
  
  pairwise_list <- parallel::mclapply(spp_ids, # id <- spp_ids[1]
                          FUN = function(id, f) {
                            process_pairwise(id, files = taxon_intsx_files, level = 'cat')
                          },
                          mc.cores = 16)
  
  pairwise_df <- bind_rows(pairwise_list)
  
  pairwise_summary <- pairwise_df %>%
    filter(!is.na(pct)) %>%
    group_by(cat1, cat2) %>%
    summarize(n_spp = n_distinct(iucn_sid),
              mean_pct = mean(pct),
              sd_pct = sd(pct)) %>%
    ungroup()
  
  mtxplot_df <- pairwise_summary %>%
    complete(cat1 = cat_order, cat2 = cat_order) %>%
    mutate(cat1 = factor(cat1, levels = cat_order),
           cat2 = factor(cat2, levels = cat_order)) %>%
    filter(as.integer(cat1) >= as.integer(cat2)) %>%
    mutate(cat1 = fct_rev(cat1))
 
  p <- ggplot(mtxplot_df, aes(x = cat1, y = cat2)) +
    ggtheme_plot() +
    geom_abline(intercept = 5, slope = -1, color = 'red', alpha = .5) +
    geom_point(aes(size = n_spp, color = mean_pct)) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1),
          axis.title = element_blank()) +
    scale_color_viridis_c() +
    labs(title = t)
  
  print(p)
}

```
