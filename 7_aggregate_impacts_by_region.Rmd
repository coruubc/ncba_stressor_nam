---
title: 'Aggregate impacts to country and ecoregion level'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
library(sf)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

reload <- FALSE
```


# Summary

Using the impact category level global maps, aggregate species impacts (for 2011-2013) and intensification (across 2003-2013) to country level.  We also aggregate to marine ecoregion level.  Values are by count and by proportion of threatened species.

# Methods

## Set up for calcs

### Get IDs for regions

Pull in EEZ raster and MEOW raster, and assemble into a dataframe.  Include ocean area for area-weighted averaging.

```{r}
eez_rast   <- raster(here('_spatial/eez_mol.tif'))
meow_rast  <- raster(here('_spatial/meow_mol.tif'))
ocean_rast <- raster(here('_spatial/ocean_area_mol.tif'))
nspp_rast  <- raster(here('_output/rasters/n_spp_map.tif'))
# priority_rast <- raster(here('_output/rasters/priority_sum_map.tif'))

eez_sf <- read_sf(file.path(dir_bd_anx, 'spatial/ohi_rgns/rgns_mol_1k.gpkg')) %>%
  filter(!str_detect(rgn_type, 'land')) %>%
  select(rgn_id, rgn_name, rgn_key, area_km2, geom)
meow_sf <- read_sf(file.path(dir_bd_anx, 'spatial/meow/meow_ecos.shp')) %>%
  janitor::clean_names()

rgn_df <- data.frame(cell_id = 1:ncell(eez_rast),
                     eez     = values(eez_rast),
                     meow    = values(meow_rast),
                     nspp    = values(nspp_rast),
                     a_prop  = values(ocean_rast)) %>%
  filter(!is.na(a_prop))
```

### Define helper functions

Define a function to bring in all rasters (by year) of an impact, and place into dataframe format.  From the raster filename, extract the stressor/impact and the year.

```{r}
rast_as_df <- function(r, rm_zero = FALSE) {
  r_df <- data.frame(cell_id = 1:ncell(r),
                     val = values(r)) %>%
    mutate(val = ifelse(rm_zero & val == 0, NA, val)) %>%
    filter(!is.na(val))
  
  return(r_df)
}

weighted.var <- function(x, w, na.rm = FALSE) {
  if (na.rm) {
      w <- w[i <- !is.na(x)]
      x <- x[i]
  }
  V1 <- sum(w);  V2 <- sum(w^2);  mean_w <- sum(x * w) / sum(w)
  result <- (V1 / (V1^2 - V2)) * sum(w * (x - mean_w)^2, na.rm = na.rm)
  return(result)
}

summarize_rast_rgn <- function(r, rgn_df, rgn = 'eez') {
  ### summarize by rgn (or meow) to calc area-weighted mean and var
  cell_a_km2 <- res(r)[1]^2 / 1e6
  r_df <- rast_as_df(r) %>%
    dt_join(rgn_df, by = 'cell_id', type = 'full') %>%
    mutate(val = ifelse(is.na(val), 0, val)) %>%
    group_by_(rgn) %>%
    summarize(val_mean = weighted.mean(val, a_prop),
              val_var  = weighted.var(val, a_prop),
              a_km2    = sum(a_prop) * cell_a_km2)
  
  return(r_df)
}

get_map <- function(str_cat, y = 2013, type = 'impact'){
  map_stem <- case_when(
    type == 'impact' ~
      here('_output', 'rasters/impact_maps', 'impact_%s_%s.tif'),
    type == 'stressor' ~
      here('_output/rasters/stressor_ftprints', 'footprint_%s_%s.tif'),
    TRUE ~ NA_character_)
  
  map_f <- sprintf(map_stem, str_cat, y)
  
  if(length(y) > 1) {
    rast <- stack(map_f) %>%
      calc(mean, na.rm = TRUE)  
  } else {
    rast <- raster(map_f)
  }
  if(type == 'stressor') { ### cut out cells with zero stressors
    rast[rast == 0] <- NA
  }
  return(rast)
}

get_impact_summary <- function(str_cat, type = 'impact', rgn_df, rgn = 'eez') {
  ### Means will be (e.g.) sum()
  r <- get_map(str_cat, y = 2011:2013, type)

  x <- summarize_rast_rgn(r, rgn_df, rgn) %>%
    mutate(impact = str_cat)
  
  return(x)
}

get_intens_summary <- function(str_cat, type = 'diff', rgn_df, rgn = 'eez') {
  ### Means will be (e.g.) sum()
  intens_stem <- here('_output/rasters/intens_maps/intens_%s_%s.tif')
  if(type == 'diff') {
    r <- raster(sprintf(intens_stem, str_cat, 'incr')) -
      raster(sprintf(intens_stem, str_cat, 'decr'))
  } else {
    r <- raster(sprintf(intens_stem, str_cat, type))
  }

  x <- summarize_rast_rgn(r, rgn_df, rgn) %>%
    mutate(impact = str_cat)
  
  return(x)
}

str_cats <- c('fishing', 'land-based', 'ocean', 'climate', 'all')

```

## Calculate impact by count and percent

### Calculate impacts by Exclusive Economic Zone

Plot the results based on the _count_ and _percent_ of local threatened species impacted by each impact category.

``` {r impact_count_by_eez}
impact_count_by_eez_file <- here('_output/impact_count_by_eez.csv')
if(!file.exists(impact_count_by_eez_file)) {
  
  impacts_by_eez_list <- parallel::mclapply(str_cats,
      FUN = get_impact_summary, rgn_df = rgn_df, rgn = 'eez',
      mc.cores = 5)

  impacts_by_eez_df <- bind_rows(impacts_by_eez_list) %>%
    rename(impact_mean = val_mean, impact_var = val_var) %>%
    filter(!is.na(eez))
  
  write_csv(impacts_by_eez_df, impact_count_by_eez_file)
}
### US EEZ should be 11,351,000 km2
### area_km2 of eez 163 = 8.586399e+06
```

To get the percent by region, divide the mean impacted species by the mean species present.  Note that the means can be divided, but the variance of the ratio is not calculated.

``` {r impact_pct_by_eez}
impact_pct_by_eez_file <- here('_output/impact_pct_by_eez.csv')
if(!file.exists(impact_pct_by_eez_file)) {
  
  impacts_by_eez_df <- read_csv(impact_count_by_eez_file)
  
  mean_spp_per_eez <- rgn_df %>%
    group_by(eez) %>%
    summarize(nspp_mean = weighted.mean(nspp, a_prop),
              nspp_var  = weighted.var(nspp, a_prop))

  imp_nspp_df <- impacts_by_eez_df %>%
    full_join(mean_spp_per_eez, by = 'eez') %>%
    mutate(pct_impact_mean = impact_mean / nspp_mean * 100) %>%
    select(eez, pct_impact_mean, a_km2, impact)
  
  write_csv(imp_nspp_df, impact_pct_by_eez_file)
}
### US EEZ should be 11,351,000 km2
### area_km2 of eez 163 = 8.586399e+06
```


```{r plot impacts by eez}

impact_pct_by_eez_df <- read_csv(impact_pct_by_eez_file)
impact_sf <- eez_sf %>%
  left_join(impact_pct_by_eez_df, by = c('rgn_id' = 'eez'))

ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'all'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'all impacts, pct')

ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'fishing'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'fishing impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'land-based'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'land-based impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'ocean'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'ocean impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'climate'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'climate impacts, pct')
  
```

### Calculate impacts by Marine Ecoregion

``` {r}
impact_count_by_meow_file <- here('_output/impact_count_by_meow.csv')
if(!file.exists(impact_count_by_meow_file)) {

  impacts_by_meow_list <- parallel::mclapply(str_cats,
      FUN = get_impact_summary, rgn_df = rgn_df, rgn = 'meow',
      mc.cores = 5)

  impacts_by_meow_df <- bind_rows(impacts_by_meow_list) %>%
    rename(impact_mean = val_mean, impact_var = val_var) %>%
    filter(!is.na(meow))
  
  write_csv(impacts_by_meow_df, impact_count_by_meow_file)
}
```

``` {r}
impact_pct_by_meow_file <- here('_output/impact_pct_by_meow.csv')
if(!file.exists(impact_pct_by_meow_file)) {

  impacts_by_meow_df <- read_csv(impact_count_by_meow_file)
  
  mean_spp_per_meow <- rgn_df %>%
    group_by(meow) %>%
    summarize(nspp_mean = weighted.mean(nspp, a_prop),
              nspp_var  = weighted.var(nspp, a_prop))

  imp_nspp_df <- impacts_by_meow_df %>%
    full_join(mean_spp_per_meow, by = 'meow') %>%
    mutate(pct_impact_mean = impact_mean / nspp_mean * 100) %>%
    select(meow, pct_impact_mean, a_km2, impact)
  
  write_csv(imp_nspp_df, impact_pct_by_meow_file)
}
```

Plot the results based on the _percent_ of local threatened species impacted by each impact category.

```{r plot impacts by meow}
impact_pct_by_meow_df <- read_csv(impact_pct_by_meow_file)
impact_sf <- meow_sf %>%
  left_join(impact_pct_by_meow_df, by = c('eco_code_x' = 'meow'))

ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'all'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'all impacts, pct')

ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'fishing'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'fishing impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'land-based'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'land-based impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'ocean'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'ocean impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = impact_sf %>% filter(impact == 'climate'), 
          aes(fill = pct_impact_mean, color = pct_impact_mean), 
          alpha = .8, size = .25) +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  labs(title = 'climate impacts, pct')
  
```


## Calculate intensification by count and percent

### Calculate intensification by Exclusive Economic Zone

Plot the results based on the _count_ and _percent_ of local threatened species under intensification by each impact category.

``` {r intens_count_by_eez}
intens_count_by_eez_file <- here('_output/intens_count_by_eez.csv')
if(!file.exists(intens_count_by_eez_file)) {
  
  intens_by_eez_list <- parallel::mclapply(str_cats,
      FUN = get_intens_summary, 
        rgn_df = rgn_df, type = 'diff', rgn = 'eez',
      mc.cores = 5)

  intens_by_eez_df <- bind_rows(intens_by_eez_list) %>%
    rename(intens_mean = val_mean, intens_var = val_var) %>%
    filter(!is.na(eez))
  
  write_csv(intens_by_eez_df, intens_count_by_eez_file)
}
### US EEZ should be 11,351,000 km2
### area_km2 of eez 163 = 8.586399e+06
```

To get the percent by region, divide the mean intensifying species by the mean species present.  Note that the means can be divided, but the variance of the ratio is not calculated.

``` {r intens_pct_by_eez}
intens_pct_by_eez_file <- here('_output/intens_pct_by_eez.csv')
if(!file.exists(intens_pct_by_eez_file)) {
  
  intens_by_eez_df <- read_csv(intens_count_by_eez_file)
  
  mean_spp_per_eez <- rgn_df %>%
    group_by(eez) %>%
    summarize(nspp_mean = weighted.mean(nspp, a_prop),
              nspp_var  = weighted.var(nspp, a_prop))

  int_nspp_df <- intens_by_eez_df %>%
    full_join(mean_spp_per_eez, by = 'eez') %>%
    mutate(pct_intens_mean = intens_mean / nspp_mean * 100) %>%
    select(eez, pct_intens_mean, a_km2, impact)
  
  write_csv(int_nspp_df, intens_pct_by_eez_file)
}
### US EEZ should be 11,351,000 km2
### area_km2 of eez 163 = 8.586399e+06
```


```{r plot intensification by eez}

intens_pct_by_eez_df <- read_csv(intens_pct_by_eez_file)
intens_sf <- eez_sf %>%
  left_join(intens_pct_by_eez_df, by = c('rgn_id' = 'eez'))

ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'all'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification all impacts, pct')

ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'fishing'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification fishing impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'land-based'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification land-based impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'ocean'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification ocean impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'climate'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification climate impacts, pct')
  
```

### Calculate intensification by Marine Ecoregion

``` {r}
intens_count_by_meow_file <- here('_output/intens_count_by_meow.csv')
if(!file.exists(intens_count_by_meow_file)) {

  intens_by_meow_list <- parallel::mclapply(str_cats,
      FUN = get_intens_summary, 
        rgn_df = rgn_df, type = 'diff', rgn = 'meow',
      mc.cores = 5)

  intens_by_meow_df <- bind_rows(intens_by_meow_list) %>%
    rename(intens_mean = val_mean, intens_var = val_var) %>%
    filter(!is.na(meow))
  
  write_csv(intens_by_meow_df, intens_count_by_meow_file)
}
```

``` {r}
intens_pct_by_meow_file <- here('_output/intens_pct_by_meow.csv')
if(!file.exists(intens_pct_by_meow_file)) {

  intens_by_meow_df <- read_csv(intens_count_by_meow_file)
  
  mean_spp_per_meow <- rgn_df %>%
    group_by(meow) %>%
    summarize(nspp_mean = weighted.mean(nspp, a_prop),
              nspp_var  = weighted.var(nspp, a_prop))

  imp_nspp_df <- intens_by_meow_df %>%
    full_join(mean_spp_per_meow, by = 'meow') %>%
    mutate(pct_intens_mean = intens_mean / nspp_mean * 100) %>%
    select(meow, pct_intens_mean, a_km2, impact)
  
  write_csv(imp_nspp_df, intens_pct_by_meow_file)
}
```

Plot the results based on the _percent_ of local threatened species impacted by each impact category.

```{r plot intensification by meow}
intens_pct_by_meow_df <- read_csv(intens_pct_by_meow_file)
intens_sf <- meow_sf %>%
  left_join(intens_pct_by_meow_df, by = c('eco_code_x' = 'meow'))

ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'all'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification all impacts, pct')

ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'fishing'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification fishing impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'land-based'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification land-based impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'ocean'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification ocean impacts, pct')
  
ggplot() +
  ggtheme_map() +
  geom_sf(data = intens_sf %>% filter(impact == 'climate'), 
          aes(fill = pct_intens_mean, color = pct_intens_mean), 
          alpha = .8, size = .25) +
  scale_fill_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  scale_color_gradient2(high = 'red4', mid = 'lightyellow', low = 'green3', 
                       midpoint = 0) +
  labs(title = 'net intensification climate impacts, pct')
  
```


