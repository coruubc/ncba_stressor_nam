---
title: 'Calculate species stressor impacts'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

dir_str_95cv <- file.path(dir_bd_anx, 'layers/stressors_10km_95cv')
dir_spp_maps <- file.path(dir_bd_anx, 'spp_rasts_mol_2020')
dir_spp_intsx <- file.path(dir_bd_anx, 'spp_str_rasts')
```


# Summary

For each species, pull in all associated stressor intersections, as well as species range.  For each year, summarize impacted range and % impacted range for each stressor, and for cumulative.  For each year, also calculate the number of impacts per cell and save as a map of species cumulative impact.

# Methods

## Create list of species for mapping cumulative impacts

Here we will identify all species with sensitivity to one or more stressor, and a range map.

```{r setup file names and species ids for processing}
spp_incl <- get_incl_spp() %>%
  filter(!is.na(stressor))

spp_ids <- spp_incl$iucn_sid %>%
  unique() %>% sort()

ocean_area_rast <- raster(here('_spatial/ocean_area_mol.tif'))
ocean_area_df <- data.frame(ocean_prop = values(ocean_area_rast),
                            cell_id = 1:ncell(ocean_area_rast))
```

## loop over species by ID

For each species, create a dataframe summarizing cumulative impacts:

* calculate individual stressor impacts range and pct
* calculate cumulative impact
* bind 'em together and save it as .csv to annex, `spp_impacts` folder.

### set up functions

```{r cumulative impact functions}
### set up list of all intersection files and an ID for indexing
intsx_files_all <- list.files(dir_spp_intsx, recursive = TRUE, full.names = TRUE)
intsx_id_vec    <- as.integer(str_extract(basename(intsx_files_all), '[0-9]{3,}'))

get_intsx_files <- function(spp_id, impacts) {
  ### NOTE: this uses global variables to avoid relisting all the intersection
  ### files each time...
  
  ### get all the intersection files for this spp in the intsx directory
  intsx_files <- intsx_files_all[intsx_id_vec == spp_id]
  ### test to see which subset if any to include
  cc_impacts <- c('oa', 'sst', 'slr')
  intsx_dirs <- basename(dirname(intsx_files))
  
  if(impacts == 'no climate') {
    intsx_files <- intsx_files[!intsx_dirs %in% cc_impacts]
  } else if(impacts == 'climate') {
    intsx_files <- intsx_files[intsx_dirs %in% cc_impacts]
  }
  
  return(intsx_files)
}

calc_cum_impact <- function(spp_id, 
                            ocean_area_df,
                            dir_spp_maps,
                            impacts = 'all') {
  ### dir_spp_maps to point to location of range files;
  ### dir_spp_intsx to point to location of intersection files
  ### ocean_area_df to calc range including coastal (i.e. not 100% ocean) cells
  ### impacts allows to select subsets of impacts
  cell_area_km2 <- 105.6633 ### from ocean raster

  ### assemble file name and read the range data
  spp_range_file <- file.path(dir_spp_maps,
                              sprintf('iucn_sid_%s.csv', spp_id))
  spp_range_df <- read_csv(spp_range_file, 
                           col_types = cols('cell_id' = 'i', 'presence' = 'i')) %>%
    left_join(ocean_area_df, by = 'cell_id')
  
  spp_range_km2 <- spp_range_df %>%
    filter(presence > 0 & !is.na(presence)) %>%
    summarize(range_km2 = sum(ocean_prop) * cell_area_km2) %>%
    .$range_km2
  
  intsx_files <- get_intsx_files(spp_id, impacts)
  
  spp_intsx_df <- lapply(intsx_files,
      FUN = function(x) { # x <- intsx_files[1]
        str_name <- basename(x) %>%
          str_replace_all('spp_intsx_|_[0-9].*', '')
        
        read_csv(x, col_types = cols('cell_id' = 'i',
                                     'year' = 'i')) %>%
          mutate(stressor = str_name)
      }) %>%
    bind_rows() %>%
    filter(!is.na(cell_id)) %>%
    left_join(ocean_area_df, by = 'cell_id')
  
  spp_impact_by_stressor <- spp_intsx_df %>%
    group_by(stressor, year) %>%
    summarize(impact_km2 = sum(ocean_prop) * cell_area_km2) %>%
    ungroup()
  
  spp_cum_impact <- spp_intsx_df %>%
    select(cell_id, year, ocean_prop) %>%
    distinct() %>%
    group_by(year) %>%
    summarize(impact_km2 = sum(ocean_prop) * cell_area_km2,
              stressor = 'cumulative')
  if(nrow(spp_cum_impact) == 0) {
    spp_cum_impact <- data.frame(
      stressor = 'cumulative',
      year = NA,
      impact_km2 = 0,
      range_km2 = spp_range_km2)
  }
  
  impact_df <- bind_rows(spp_impact_by_stressor, spp_cum_impact) %>%
    mutate(range_km2 = spp_range_km2,
           pct_impact = impact_km2 / range_km2,
           iucn_sid = spp_id)
  
  return(impact_df)
}

map_cum_impact <- function(spp_id, 
                           dir_spp_maps,
                           impacts = 'all') {
  ### dir_spp_maps to point to location of range files;
  ### dir_spp_intsx to point to location of intersection files

  ### assemble file name and read the range data
  spp_range_file <- file.path(dir_spp_maps,
                              sprintf('iucn_sid_%s.csv', spp_id))
  spp_range_df <- read_csv(spp_range_file, 
                           col_types = cols('cell_id' = 'i', 'presence' = 'i'))
  
  intsx_files <- get_intsx_files(spp_id, impacts)
  
  spp_intsx_df <- lapply(intsx_files,
      FUN = function(x) { # x <- intsx_files[1]
        str_name <- basename(x) %>%
          str_replace_all('spp_intsx_|_[0-9].*', '')
        
        read_csv(x, col_types = cols('cell_id' = 'i',
                                     'year' = 'i')) %>%
          mutate(stressor = str_name)
      }) %>%
    bind_rows() %>%
    filter(!is.na(cell_id)) 

  spp_cum_impact_map <- spp_range_df %>%
    left_join(spp_intsx_df, by = 'cell_id') %>%
      ### left_join keeps totally unimpacted cells
    group_by(cell_id, year) %>%
    summarize(n_impacts = sum(!is.na(stressor))) %>%
    ungroup() %>%
    filter(!is.na(year))
    ### Note: totally unimpacted cells will have an NA for year and
    ### zero for n_impacts; cells with impacts some years and not others
    ### will only have data for impact years...
    ### dropping these observations will make for smaller files; unimpacted
    ### ranges can be added back in later from the range map files.
  
  if(nrow(spp_cum_impact_map) == 0) {
    ### for spp with no impacts in current impact group
    spp_cum_impact_map <- data.frame(cell_id = NA, 
                                     n_impacts = 0, 
                                     year = 2003:2013)
  }
  
  return(spp_cum_impact_map)
}

```

### calculate species cumulative impacts, non-CC

``` {r calc species cumulative impacts nonclimate}

reload <- FALSE
### to clear old versions:
# x <- list.files(file.path(dir_bd_anx, 'spp_impacts'), full.names = TRUE)
# # x <- x[str_detect(x, 'no_cc')]
# unlink(x)

# for(spp_id in spp_ids) {
tmp <- parallel::mclapply(spp_ids, mc.cores = 12,
  FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    
    spp_impact_file <- file.path(dir_bd_anx, 'spp_impacts',
                                 sprintf('spp_impacts_%s_no_cc.csv', spp_id))
    if(!file.exists(spp_impact_file) | reload) {
      message('Processing spp ', spp_id, '; non-climate')
      ### Calculate total species range, accounting for partial ocean cells
      impact_df <- calc_cum_impact(spp_id, ocean_area_df,
                                   dir_spp_maps,
                                   impacts = 'no climate')
      write_csv(impact_df, spp_impact_file)
    } else {
      # message('Impact df file exists: ', basename(spp_impact_file), '... skipping!')
    }
    return(paste('success:', spp_id))
  }
)

```

### calculate species cumulative impacts, CC only

``` {r calc species cumulative impacts climate only}

reload <- FALSE
### to clear old versions:
### x <- list.files(file.path(dir_bd_anx, 'spp_impacts'), full.names = TRUE)
### x <- x[str_detect(x, 'cc_only')]
### unlink(x)

# for(spp_id in spp_ids) {
tmp <- parallel::mclapply(spp_ids, mc.cores = 12,
  FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    
    spp_impact_file <- file.path(dir_bd_anx, 'spp_impacts',
                                 sprintf('spp_impacts_%s_cc_only.csv', spp_id))
    if(!file.exists(spp_impact_file) | reload) {
      message('Processing spp ', spp_id, '; climate only')
      ### Calculate total species range, accounting for partial ocean cells
      impact_df <- calc_cum_impact(spp_id, ocean_area_df,
                                   dir_spp_maps,
                                   impacts = 'climate')
      write_csv(impact_df, spp_impact_file)
    } else {
      # message('Impact df file exists: ', basename(spp_impact_file), '... skipping!')
    }
    return(paste('success:', spp_id))
  }
)

```

## Calculate maps of cumulative impacts

For each species, create a map of cumulative impacts:

* `left_join` each stressor intersection to the species range by `cell_id`
* summarize number of stressors in each cell
* write out as .csv to annex, `spp_impact_rasts`

Each of these will be performed for non-climate stressors, and then separately for climate stressors.  Full cumulative can be found from simply adding 'em up.

### map species cumulative impacts, non-CC

``` {r map species cumulative impacts nonclimate, eval = TRUE}

reload <- FALSE
### to clear old versions:
### x <- list.files(file.path(dir_bd_anx, 'spp_impact_rasts'), full.names = TRUE)
### x <- x[str_detect(x, 'no_cc')]
### unlink(x)

for(spp_id in spp_ids) {
# tmp <- parallel::mclapply(spp_ids, mc.cores = 4, 
#   FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    impact_rast_file <- file.path(dir_bd_anx, 'spp_impact_rasts',
                                 sprintf('spp_impact_map_%s_no_cc.csv', spp_id))
    if(!file.exists(impact_rast_file) | reload) {
      message('Mapping spp ', spp_id, '; non-climate change')
      ### Calculate total species range, accounting for partial ocean cells
      impact_rast <- map_cum_impact(spp_id,
                                    dir_spp_maps,
                                    impacts = 'no climate')
      write_csv(impact_rast, impact_rast_file)
    } else {
      # message('Impact map file exists: ', basename(impact_rast_file), '... skipping!')
    }
    # return(paste('success:', spp_id))
  }
# )

```

### map species cumulative impacts, climate only

``` {r map species cumulative impacts climate only, eval = TRUE}

reload <- FALSE
### to clear old versions:
### x <- list.files(file.path(dir_bd_anx, 'spp_impact_rasts'), full.names = TRUE)
### x <- x[str_detect(x, 'cc_only')]
### unlink(x)

# for(spp_id in spp_ids) {
tmp <- parallel::mclapply(spp_ids, mc.cores = 8, 
  FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    impact_rast_file <- file.path(dir_bd_anx, 'spp_impact_rasts',
                                 sprintf('spp_impact_map_%s_cc_only.csv', spp_id))
    if(!file.exists(impact_rast_file) | reload) {
      message('Mapping spp ', spp_id, '; climate only')
      ### Calculate total species range, accounting for partial ocean cells
      impact_rast <- map_cum_impact(spp_id,
                                    dir_spp_maps,
                                    impacts = 'climate')
      write_csv(impact_rast, impact_rast_file)
    } else {
      # message('Impact map file exists: ', basename(impact_rast_file), '... skipping!')
    }
    return(paste('success:', spp_id))
  })

```


```{r, eval = FALSE}
x <- list.files(file.path(dir_bd_anx, 'spp_impacts'))
iucn_sid_done <- str_extract(x, '[0-9]+') %>% as.integer() %>% sort()
y <- spp_ids[!spp_ids %in% iucn_sid_done]

```

## Check species affected by sea level rise

The SLR maps cover the entire ocean, not just coastal zones, but SLR should not affect any pelagic species.  Here, check the species that are impacted by sea level rise and map them to make sure none extend oceanward.

```{r}
cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))

map_to_rast <- function(map_df, cell_val = 'n_spp') {
  # map_rast <- raster::subs(cell_id_rast, as.data.frame(map_df), 
  #                          by = 'cell_id', which = val)
  map_rast <- raster(cell_id_rast)
  values(map_rast)[map_df$cell_id] <- map_df[[cell_val]]
  return(map_rast)
}
```

```{r, eval = TRUE}
### examine sea level rise species impacts: do they extend into
### pelagic waters?

x <- read_csv('_output/spp_sens_climate_2020-1.csv') %>%
  filter(stressor == 'slr' & sens == TRUE)
### 74 here
y <- read_csv(file.path(dir_bd_anx, 'iucn', 'spp_info_from_api_2020-1.csv')) %>%
  filter(iucn_sid %in% x$iucn_sid)

### to delete the species impact maps with SLR impacts
# spp_impact_files <- list.files(file.path(dir_bd_anx, 'spp_impact_rasts'),
#                                full.names = TRUE)
# slr_spp_df <- data.frame(f = spp_impact_files) %>%
#   mutate(iucn_sid = str_extract(basename(f), '[0-9]{3,}') %>% as.integer()) %>%
#   filter(iucn_sid %in% x$iucn_sid)
# unlink(slr_spp_df$f)

slr_spp_files <- list.files(file.path(dir_spp_intsx, 'slr'),
                            full.names = TRUE)

slr_spp_maps <- parallel::mclapply(slr_spp_files, 
                         FUN = function(f) {
                           id <- str_extract(basename(f), '[0-9]{3,}') %>% as.integer()
                           x <- read_csv(f, col_types = 'ii') %>%
                             mutate(iucn_sid = id)
                         }, mc.cores = 40) %>%
  bind_rows() %>%
  filter(!is.na(cell_id))

yrs <- 2013# c(2003,2013)
map_list <- vector('list', length = length(yrs))
for(i in seq_along(yrs)) {
  ### i <- 2
  yr <- yrs[i]
  slr_spp_yr <- slr_spp_maps %>%
    filter(year == yr) 
  # slr_spp <- slr_spp_yr$iucn_sid %>% unique()
  ### 71 here
  slr_all_yr <- slr_spp_yr %>%
    group_by(cell_id) %>%
    summarize(n_spp = n_distinct(iucn_sid))
  map_list[[i]] <- map_to_rast(slr_all_yr)
}

map_stack <- stack(map_list)

plot(map_stack, main = paste0('SLR spp ', yrs))
```

