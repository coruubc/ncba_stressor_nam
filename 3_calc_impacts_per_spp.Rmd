---
title: 'Calculate species stressor impacts'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

dir_str_95cv <- file.path(dir_bd_anx, 'layers/stressors_10km_95cv')
dir_spp_maps <- file.path(dir_bd_anx, 'spp_rasts_mol_2019')
```


# Summary

For each species, pull in all associated stressor intersections, as well as species range.  For each year, summarize impacted range and % impacted range for each stressor, and for cumulative.  For each year, also calculate the number of impacts per cell and save as a map of species cumulative impact.

# Methods

## create list of spp

```{r setup file names and species ids for processing}
spp_sens_file <- here('_output', sprintf('spp_sensitivity_%s.csv', api_version))
spp_sensitivity <- read_csv(spp_sens_file,
                            col_types = cols('iucn_sid' = 'i'))

spp_ids <- spp_sensitivity$iucn_sid %>%
  unique() %>% sort()

spp_range_dir <- file.path(dir_bd_anx, 'spp_rasts_mol_2019')
spp_intsx_dir <- file.path(dir_bd_anx, 'spp_str_rasts')

### read all the species/stressor intersection files (.csv files
### representing stressor & species co-presence in a cell)
# spp_str_intsx_files <- list.files(file.path(dir_bd_anx, 'spp_str_rasts'),
#                                   recursive = TRUE,
#                                   full.names = TRUE)
### from the filename, extract the spp id (note, the {3, } will not grab the
### '10' from '10km' in the filename)
# spp_str_intsx_ids <- basename(spp_str_intsx_files) %>%
#   str_extract('[0-9]{3, }+') %>%
#   as.integer()
#   
# spp_str_intsx_df <- data.frame(intsx_file = spp_str_intsx_files,
#                                iucn_sid = spp_str_intsx_ids)

### make sure all spp IDs represented in intersection dataframe
# all(spp_ids %in% spp_str_intsx_df$iucn_sid)
# TRUE

ocean_area_rast <- raster(here('_spatial/ocean_area_mol.tif'))
ocean_area_df <- data.frame(ocean_prop = values(ocean_area_rast),
                            cell_id = 1:ncell(ocean_area_rast))
```

## loop over species by ID

For each species, create a dataframe summarizing cumulative impacts:

* calculate individual stressor impacts range and pct
* calculate cumulative impact
* bind 'em together and save it as .csv to annex, `spp_impacts` folder.

### set up functions

```{r cumulative impact functions}

get_intsx_files <- function(spp_id, spp_intsx_dir, impacts) {
  ### get all the intersection files for this spp in the intsx directory
  intsx_files <- list.files(spp_intsx_dir,
                            pattern = as.character(spp_id),
                            recursive = TRUE,
                            full.names = TRUE)
  ### test to see which subset if any to include
  cc_impacts <- c('oa', 'sst', 'slr')
  intsx_dirs <- basename(dirname(intsx_files))
  
  if(impacts == 'no climate') {
    intsx_files <- intsx_files[!intsx_dirs %in% cc_impacts]
  } else if(impacts == 'climate') {
    intsx_files <- intsx_files[intsx_dirs %in% cc_impacts]
  }
  
  return(intsx_files)
}

calc_cum_impact <- function(spp_id, 
                            ocean_area_df,
                            spp_range_dir,
                            spp_intsx_dir,
                            impacts = 'all') {
  ### spp_range_dir to point to location of range files;
  ### spp_intsx_dir to point to location of intersection files
  ### ocean_area_df to calc range including coastal (i.e. not 100% ocean) cells
  ### impacts allows to select subsets of impacts

  ### assemble file name and read the range data
  spp_range_file <- file.path(spp_range_dir,
                              sprintf('iucn_sid_%s_mol.csv', spp_id))
  spp_range_df <- read_csv(spp_range_file, 
                           col_types = cols('cell_id' = 'i', 'presence' = 'i')) %>%
    left_join(ocean_area_df, by = 'cell_id')
  
  spp_range_km2 <- spp_range_df %>%
    filter(presence > 0 & !is.na(presence)) %>%
    summarize(range_km2 = sum(ocean_prop) * 100) %>%
    .$range_km2
  
  intsx_files <- get_intsx_files(spp_id, spp_intsx_dir, impacts)
  
  spp_intsx_df <- lapply(intsx_files,
      FUN = function(x) { # x <- intsx_files[1]
        str_name <- basename(x) %>%
          str_replace_all('spp_intsx_|_[0-9].*', '')
        
        read_csv(x, col_types = cols('cell_id' = 'i',
                                     'year' = 'i')) %>%
          mutate(stressor = str_name)
      }) %>%
    bind_rows() %>%
    filter(!is.na(cell_id)) %>%
    left_join(ocean_area_df, by = 'cell_id')
  
  spp_impact_by_stressor <- spp_intsx_df %>%
    group_by(stressor, year) %>%
    summarize(impact_km2 = sum(ocean_prop) * 100) %>%
    ungroup()
  
  spp_cum_impact <- spp_intsx_df %>%
    select(cell_id, year, ocean_prop) %>%
    distinct() %>%
    group_by(year) %>%
    summarize(impact_km2 = sum(ocean_prop) * 100,
              stressor = 'cumulative')
  if(nrow(spp_cum_impact) == 0) {
    spp_cum_impact <- data.frame(
      stressor = 'cumulative',
      year = NA,
      impact_km2 = 0,
      range_km2 = spp_range_km2)
  }
  
  impact_df <- bind_rows(spp_impact_by_stressor, spp_cum_impact) %>%
    mutate(range_km2 = spp_range_km2,
           pct_impact = impact_km2 / range_km2,
           iucn_sid = spp_id)
  
  return(impact_df)
}

map_cum_impact <- function(spp_id, 
                           spp_range_dir,
                           spp_intsx_dir,
                           impacts = 'all') {
  ### spp_range_dir to point to location of range files;
  ### spp_intsx_dir to point to location of intersection files

  ### assemble file name and read the range data
  spp_range_file <- file.path(spp_range_dir,
                              sprintf('iucn_sid_%s_mol.csv', spp_id))
  spp_range_df <- read_csv(spp_range_file, 
                           col_types = cols('cell_id' = 'i', 'presence' = 'i'))
  
  intsx_files <- get_intsx_files(spp_id, spp_intsx_dir, impacts)
  
  spp_intsx_df <- lapply(intsx_files,
      FUN = function(x) { # x <- intsx_files[1]
        str_name <- basename(x) %>%
          str_replace_all('spp_intsx_|_[0-9].*', '')
        
        read_csv(x, col_types = cols('cell_id' = 'i',
                                     'year' = 'i')) %>%
          mutate(stressor = str_name)
      }) %>%
    bind_rows() %>%
    filter(!is.na(cell_id)) 

  spp_cum_impact_map <- spp_range_df %>%
    left_join(spp_intsx_df, by = 'cell_id') %>%
      ### left_join keeps totally unimpacted cells
    group_by(cell_id, year) %>%
    summarize(n_impacts = sum(!is.na(stressor))) %>%
    ungroup() %>%
    filter(!is.na(year))
    ### Note: totally unimpacted cells will have an NA for year and
    ### zero for n_impacts; cells with impacts some years and not others
    ### will only have data for impact years...
    ### dropping these observations will make for smaller files; unimpacted
    ### ranges can be added back in later from the range map files.
  
  if(nrow(spp_cum_impact_map) == 0) {
    ### for spp with no impacts in current impact group
    spp_cum_impact_map <- data.frame(cell_id = NA, 
                                     n_impacts = 0, 
                                     year = 2003:2013)
  }
  
  return(spp_cum_impact_map)
}

```

### calculate species cumulative impacts, non-CC

``` {r calc species cumulative impacts nonclimate}

reload <- FALSE
### to clear old versions:
### x <- list.files(file.path(dir_bd_anx, 'spp_impacts'), full.names = TRUE)
### x <- x[str_detect(x, 'no_cc')]
### unlink(x)

# for(spp_id in spp_ids) {
tmp <- parallel::mclapply(spp_ids, mc.cores = 12,
  FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    
    spp_impact_file <- file.path(dir_bd_anx, 'spp_impacts',
                                 sprintf('spp_impacts_%s_no_cc.csv', spp_id))
    if(!file.exists(spp_impact_file) | reload) {
      message('Processing spp ', spp_id, '; no climate')
      ### Calculate total species range, accounting for partial ocean cells
      impact_df <- calc_cum_impact(spp_id, ocean_area_df,
                                   spp_range_dir,
                                   spp_intsx_dir,
                                   impacts = 'no climate')
      write_csv(impact_df, spp_impact_file)
    } else {
      message('Impact df file exists: ', basename(spp_impact_file), '... skipping!')
    }
    return(paste('success:', spp_id))
  }
)

```

### calculate species cumulative impacts, CC only

``` {r calc species cumulative impacts climate only}

reload <- FALSE
### to clear old versions:
### x <- list.files(file.path(dir_bd_anx, 'spp_impacts'), full.names = TRUE)
### x <- x[str_detect(x, 'cc_only')]
### unlink(x)

# for(spp_id in spp_ids) {
tmp <- parallel::mclapply(spp_ids, mc.cores = 12,
  FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    
    spp_impact_file <- file.path(dir_bd_anx, 'spp_impacts',
                                 sprintf('spp_impacts_%s_cc_only.csv', spp_id))
    if(!file.exists(spp_impact_file) | reload) {
      message('Processing spp ', spp_id, '; climate only')
      ### Calculate total species range, accounting for partial ocean cells
      impact_df <- calc_cum_impact(spp_id, ocean_area_df,
                                   spp_range_dir,
                                   spp_intsx_dir,
                                   impacts = 'climate')
      write_csv(impact_df, spp_impact_file)
    } else {
      message('Impact df file exists: ', basename(spp_impact_file), '... skipping!')
    }
    return(paste('success:', spp_id))
  }
)

```

## Calculate maps of cumulative impacts

For each species, create a map of cumulative impacts:

* `left_join` each stressor intersection to the species range by `cell_id`
* summarize number of stressors in each cell
* write out as .csv to annex, `spp_impact_rasts`

Each of these will be performed for non-climate stressors, and then separately for climate stressors.  Full cumulative can be found from simply adding 'em up.

### map species cumulative impacts, non-CC

``` {r map species cumulative impacts nonclimate, eval = TRUE}

reload <- FALSE
### to clear old versions:
### x <- list.files(file.path(dir_bd_anx, 'spp_impact_rasts'), full.names = TRUE)
### x <- x[str_detect(x, 'no_cc')]
### unlink(x)

for(spp_id in spp_ids) {
# tmp <- parallel::mclapply(spp_ids, mc.cores = 4, 
#   FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    impact_rast_file <- file.path(dir_bd_anx, 'spp_impact_rasts',
                                 sprintf('spp_impact_map_%s_no_cc.csv', spp_id))
    if(!file.exists(impact_rast_file) | reload) {
      message('Mapping spp ', spp_id, '; no climate change')
      ### Calculate total species range, accounting for partial ocean cells
      impact_rast <- map_cum_impact(spp_id,
                                    spp_range_dir,
                                    spp_intsx_dir,
                                    impacts = 'no climate')
      write_csv(impact_rast, impact_rast_file)
    } else {
      message('Impact map file exists: ', basename(impact_rast_file), '... skipping!')
    }
    # return(paste('success:', spp_id))
  }
# )

```

### map species cumulative impacts, climate only

``` {r map species cumulative impacts climate only, eval = TRUE}

reload <- FALSE
### to clear old versions:
### x <- list.files(file.path(dir_bd_anx, 'spp_impact_rasts'), full.names = TRUE)
### x <- x[str_detect(x, 'cc_only')]
### unlink(x)

# for(spp_id in spp_ids) {
tmp <- parallel::mclapply(spp_ids, mc.cores = 8, 
  FUN = function(spp_id) {
    ### spp_id <- spp_ids[2]
    ### spp_id <- y[1]
    impact_rast_file <- file.path(dir_bd_anx, 'spp_impact_rasts',
                                 sprintf('spp_impact_map_%s_cc_only.csv', spp_id))
    if(!file.exists(impact_rast_file) | reload) {
      message('Mapping spp ', spp_id, '; climate only')
      ### Calculate total species range, accounting for partial ocean cells
      impact_rast <- map_cum_impact(spp_id,
                                    spp_range_dir,
                                    spp_intsx_dir,
                                    impacts = 'climate')
      write_csv(impact_rast, impact_rast_file)
    } else {
      message('Impact map file exists: ', basename(impact_rast_file), '... skipping!')
    }
    return(paste('success:', spp_id))
  })

```


```{r, eval = FALSE}
x <- list.files(file.path(dir_bd_anx, 'spp_impacts'))
iucn_sid_done <- str_extract(x, '[0-9]+') %>% as.integer() %>% sort()
y <- spp_ids[!spp_ids %in% iucn_sid_done]

```


