---
title: 'Map stressor extent to 95% contour volume'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
# library(rgeos)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')  ###
  ### includes library(tidyverse); library(stringr); dir_M points to ohi directory

source(here('common_fxns.R'))
source(here('_setup/rasterize_fxns.R'))

```

# Summary

Using the stressor maps, aggregated to 10 km Mollweide, determine the threshold for 95% contour volume based on the entire time series of stressor, then clip the maps to values at or above that threshold.  Save the resulting maps as .csvs for each stressor over all years, containing `cell_id`, `stressor`, `year`, `value`.  The `value` field can be normalized later if desired.

# Data sources

Halpern et al. 2019

# Methods

## Make list of all stressor layers

Get all the stressor layers that have been aggregated to 10 km Mollweide.

```{r}
str_files_all <- list.files(file.path(dir_bd_anx, 'layers/stressors_10km'),
                        pattern = '.tif', full.names = TRUE)

str_df <- data.frame(file = str_files_all) %>%
  mutate(stressor = str_replace(basename(file), '_[0-9]{4}.+', ''),
         year = as.integer(str_extract(basename(file), '[0-9]{4}')))

```

## Loop over all stressors, process 95% contour volume

For each stressor, across the entire time series, determine a threshold for the 95% contour volume.  Use this threshold to clip values in all years of the stressor and save each year's map as a raster.  After determining the threshold, use `mclapply` for parallel calculations.

### Determine thresholds for each stressor

Gather all rasters for a given stressor, arrange values from high to low, determine the 95% contour volume threshold.  While we are at it, calculate 95% contour volume threshold for each year to examine changes over time.  Save these values as a csv.

```{r}
reload <- FALSE
str_thresh_file <- here('_output', 'str_thresholds_95cv.csv')

if(!file.exists(str_thresh_file) | reload) {
  stressors <- str_df$stressor %>% unique() %>% sort()
  
  thresh_list <- parallel::mclapply(stressors, mc.cores = 4,
    FUN = function(str) {
      ### str <- stressors[1]
      str_fs <- str_df %>%
        filter(stressor == str) %>%
        .$file
      
      str_stack <- raster::stack(str_fs)
      thresh <- calc_cv_thresh(str_stack, pct = 0.95)
      tmp_df <- data.frame(
        stressor = str,
        thresh = thresh,
        timescale = 'all years')
      return(tmp_df)
    })
  
  thresh_annual_list <- parallel::mclapply(1:nrow(str_df), mc.cores = 12,
    FUN = function(i) { ### i <- 1
      str_year_df <- str_df[i, ]
      f <- str_year_df$file
      message('Processing ', basename(f))
      rast <- raster(f)
      thresh <- calc_cv_thresh(rast, pct = 0.95)
      tmp_df <- data.frame(
        stressor = str_year_df$stressor,
        year = str_year_df$year,
        thresh = thresh,
        timescale = 'annual')
      return(tmp_df)
    })
  
  thresh_df <- bind_rows(thresh_list, thresh_annual_list)
  
  write_csv(thresh_df, str_thresh_file)
} else {
  message('File exists: ', str_thresh_file, '... reading from file')
  thresh_df <- read_csv(str_thresh_file)
}
```


### Clip individual stressor maps to 95% contour volume

Using the all years threshold, clip each stressor map to values greater than the threshold.  

```{r}
reload <- FALSE

stressors <- str_df$stressor %>% unique() %>% sort()

tmp <- parallel::mclapply(stressors, mc.cores = 8,
  FUN = function(str) { ### str <- stressors[1]
    message('Processing ', str)
    
    ### get the raw raster file(s) for this stressor
    str_year_df <- str_df %>%
      filter(stressor == str)
    f <- str_year_df$file
    
    ### get the threshold for this stressor from the saved threshold df
    thresh_all_yrs <- thresh_df %>%
      filter(timescale == 'all years') %>%
      filter(stressor == str) %>%
      .$thresh
    
    ### set up filename(s) for the output(s)
    new_files <- str_replace(basename(f), '.tif', '_95cv.tif') %>%
      str_replace('_rescaled', '')
    outfiles <- file.path(dir_bd_anx, 'layers/stressors_10km_95cv',
                         new_files)
    
    if(any(!file.exists(outfiles)) | reload) {
      ### gather all rasters for this stressor into a stack
      str_stack <- raster::stack(f)
      str_stack_95cv <- map_contour_volume(str_stack, thresh = thresh_all_yrs)
      writeRaster(str_stack_95cv, outfiles, bylayer = TRUE, overwrite = TRUE)
    } else {
      message('95% contour volume files exist for stressor: ', str, '... skipping!')
    }
  })
```

## Map results for most recent year

For each stressor, choose the most recent year.  Map the 95% contour volume map against the full map - setting values for the full map to one (normalized) value and the values for the 95% contour volume to another to show contrast.  Because all the 95% contour volume cells are within the full raster, we can simply plot it in a different color on top of the full raster.

Here, green is the raster condensed to the 95% contour volume while dark red is the full raster.

```{r}
str_95cv_files <- list.files(file.path(dir_bd_anx, 'layers/stressors_10km_95cv'),
                             full.names = TRUE)
str_full_files <- list.files(file.path(dir_bd_anx, 'layers/stressors_10km'),
                             full.names = TRUE)
str_file_df <- data.frame(str_95cv = str_95cv_files,
                          str_full = str_full_files) %>%
  mutate(str  = str_replace_all(basename(str_full), '_[0-9].*', ''),
         year = str_extract(basename(str_full), '[0-9]{4}'),
         year = as.integer(year)) %>%
  group_by(str) %>%
  filter(year == max(year))

for(stressor in str_file_df$str) {
  ### stressor <- str_file_df$str[1]
  message('plotting map for ', stressor)
  file_df <- str_file_df %>%
    filter(str == stressor)
  rast_full <- raster(file_df$str_full)
  rast_full_norm <- rast_full / rast_full
  rast_95cv <- raster(file_df$str_95cv)
  rast_95cv_norm <- rast_95cv / rast_95cv

  vec_full <- values(rast_full)
  vec_95cv <- values(rast_95cv)
  a_full <- vec_full[!is.na(vec_full) & vec_full > 0] %>% length()
  a_95cv <- vec_95cv[!is.na(vec_95cv) & vec_95cv > 0] %>% length()
  
  a_condensed <- round(a_95cv / a_full * 100, 2)
  plot_title <- sprintf('%s: %s pct of full area', stressor, a_condensed)
  plot(rast_full_norm, 
       main = plot_title, col = 'darkred', legend = FALSE)
  plot(rast_95cv_norm, 
       col = 'green', add = TRUE, legend = FALSE)
}
```

