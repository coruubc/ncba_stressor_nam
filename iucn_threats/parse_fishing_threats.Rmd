---
title: 'Parse fishing threats'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

source(here::here('common_fxns.R'))

### provenance tracking
library(provRmd); prov_setup()

```

# Summary

Examine threats to marine species as determined by IUCN threat classifications and text dismemberment of IUCN species narratives.  Crosswalk these against CHI threats.

# Data Sources

### IUCN Red List

# Methods

## Check for fishing threats by threat code

Categories of threats from fishing and harvesting aquatic resource include targeted, bycatch (unintentional effects), persecution/control, and unknown:
```{r}
threat_class <- read_csv(file.path(dir_git, '_raw/iucn_threat_class.csv')) %>%
  filter(str_detect(code, '^5\\.4')) %>%
  mutate(desc = str_replace(desc, '.+?: ', ''))

library(flextable)
ftable_theme <- function(df) {
  flextable(df) %>%
    theme_zebra() %>%
    align(part = 'all', align = 'center') %>%
    bg(bg = 'white', part = 'header') %>%
    border(border.bottom = officer::fp_border(), part = 'header') %>%
    font(font = 'Arial', part = 'all') %>%
    fontsize(size = 8, part = 'all')
}
threat_class %>% 
  ftable_theme() %>% 
  width(j = 2, 6) %>%
  align(j = 2, align = 'left', part = 'body')
```

Variables in the threat report include timing, scope, severity, and score.  Filtering rules to determine whether a species is "impacted" by fishing pressure and thus benefits from removal of fishing pressure:

* `timing` is not "Past, Unlikely to Return"
* `scope` is any scope (i.e. `NA`, "Unknown", "Minority (<50%)", "Majority (50-90%)", "Whole (>90%)")
* `score` is greater than some threshold?  
    * high impact is `score_num` of 8 or greater
    * medium impact is `score_num` of 6 or 7
    * low is 3-4-5
    * no/negligible is 0 or 1 (2 does not appear in this subset of data)
* If no valid `score` then look at `severity`; perhaps choose some threshold e.g. "rapid" or "very rapid" declines:
    * NA, "Unknown"                         
    * "No decline", "Negligible declines"
    * "Slow, Significant Declines"
    * "Rapid Declines", "Very Rapid Declines"
    * "Causing/Could cause fluctuations"
    

    
    
```{r}

spp_threats <- read_csv(file.path(dir_o_anx, 'iucn/threats',
                                  sprintf('iucn_spp_threats_%s.csv', api_version)))

score_thresh <- 6
severity_include <- c('Slow, Significant Declines',
                      'Rapid Declines', 
                      'Very Rapid Declines', 
                      'Causing/Could cause fluctuations')
fis_threats <- spp_threats %>%
  filter(str_detect(code, '^5\\.4')) %>%
  filter(timing != 'Past, Unlikely to Return' | is.na(timing)) %>%
  filter(score_num >= score_thresh | severity %in% severity_include)

write_csv(fis_threats, here('iucn_threats/int', 'fis_threat_by_code.csv'))

```

What species are represented in this filtered set? what is the distribution of extinction risk categories included?

```{r}
iucn_spp_info <- read_csv(file.path(dir_o_anx, 'iucn', 'spp_info_from_api_2019-1.csv'))
risk_codes <- read_csv(here('_raw/risk_code_lookup.csv'))

fis_threat_spp <- read_csv(here('iucn_threats/int', 'fis_threat_by_code.csv')) %>%
  select(iucn_sid) %>%
  distinct() %>%
  left_join(iucn_spp_info, by = 'iucn_sid') %>%
  left_join(risk_codes, by = c('category' = 'code')) %>%
  mutate(phl_class = paste(phylum, class, sep = ':')) %>%
  group_by(phl_class) %>%
  mutate(n_in_class = n()) %>%
  ungroup() %>%
  arrange(n_in_class) %>%
  mutate(phl_class = fct_inorder(phl_class)) %>%
  arrange(cat_score) %>%
  mutate(code = fct_inorder(code_current))

ggplot(fis_threat_spp, aes(x = phl_class)) +
  ggtheme_plot() +
  geom_bar() +
  coord_flip() +
  theme(axis.title.y = element_blank()) +
  labs(y = 'Species exposed to fishing impacts')

ggplot(fis_threat_spp, aes(x = code)) +
  ggtheme_plot() +
  geom_bar() +
  labs(x = 'IUCN Red List extinction risk',
       y = 'Species exposed to fishing impacts')

```


## Check for bycatch and gear instances in narratives

Since trawl surveys are often used for research, we can look for "trawl" but not "survey" as a pattern; are there any other troublesome patterns?

```{r, eval = FALSE}

trawl_df <- read_csv(spp_narr_file) %>%
  select(-name, -param_id, -api_error) %>%
  gather(dimension, text, -iucn_sid) %>%
  mutate(text_short = str_split(tolower(text), '\\. ')) %>%
  unnest(text_short) %>%
  filter(str_detect(text_short, 'trawl')) %>%
  mutate(post_dyad = str_extract(text_short, 'trawl[a-z]* [^\\. ]+'),
         pre_dyad = str_extract(text_short, '[^\\. ]+ trawl[a-z]*'))

```

Potential combinations to exclude:

* trawl survey
* fishery-independent trawl, exploratory trawl, experimental trawl
* research trawl, scientific trawl
* trawl sample, trawl experiment, trawl research

```{r}

spp_narr_file <- file.path(dir_o_anx, 'iucn', 
                           sprintf('spp_narr_from_api_%s.csv', api_version))

spp_narr_df <- read_csv(spp_narr_file) %>%
  select(-name, -param_id, -api_error) %>%
  distinct()

gear_narr_df <- spp_narr_df %>%
  gather(dimension, text, -iucn_sid) %>%
  group_by(iucn_sid, dimension) %>%
  summarize(text = paste(text, collapse = '\n\n')) %>%
  ungroup() %>%
  mutate(text_lc = tolower(text)) %>%
  filter(str_detect(text_lc, 'by.?catch|long.?line|seine|gill.?net|trawl'))

### Trawl exceptions are tricky, so let's do them separately by
### counting all, then subtracting the exceptions
except_str <- c('(explora|experim|research|scientific|fisher[a-z]+.indep)[a-z]* trawl',
  'trawl[a-z]* (surv|sample|experiment|research)') %>%
  paste0(collapse = '|')
  ### The first term looks for "trawl" preceded by an exclusion term;
  ### the second term looks for "trawl" (and maybe a suffix, e.g. "ing") followed by
  ### an exclusion term.
  ### Collapsing them with an OR operator allows for compound exclusions, e.g.
  ### "fishery-independent trawl survey", without double counting.

trawl_narr_class <- gear_narr_df %>%
  mutate(trawl_count = str_count(text_lc, 'trawl'),
         trawl_count = trawl_count - str_count(text_lc, except_str)) %>%
  select(-text_lc)

gear_narr_class <- gear_narr_df %>%
  mutate(bycatch_count  = str_count(text_lc, 'by.?catch'),
         longline_count = str_count(text_lc, 'long.?line'),
         seine_count    = str_count(text_lc, 'seine'),
         gillnet_count  = str_count(text_lc, 'gill.?net')) %>%
  select(-text_lc) %>%
  full_join(trawl_narr_class, by = c('iucn_sid', 'text', 'dimension'))

write_csv(gear_narr_class, file.path(dir_o_anx, 'iucn/threats/gear_narr_classified.csv'))
```


## Combine threat assessment with narrative threats

Examine the combination of species with fishing as a major threat, with the gear type breakdown from the narratives.  By `inner_join`ing the narrative info to the threat classifications, only species with fishing listed as a major threat are kept, though some of these may not have narratives with which to classify gear types (particularly for LC species).

This table is not saved but is easy to recreate from the inputs.

```{r}
fis_threat_sum <- read_csv(here('iucn_threats/int', 'fis_threat_by_code.csv')) %>%
  filter(code != '5.4') %>%  ### redundant
  select(iucn_sid, severity, score_num, code, desc = title) %>%
  distinct()

gear_narr_sum  <- read_csv(file.path(dir_o_anx, 'iucn/threats', 
                                     'gear_narr_classified.csv')) %>%
  # filter(dimension == 'threats') %>%
  group_by(iucn_sid) %>%
  summarize(bycatch_count  = sum(bycatch_count),
            longline_count = sum(longline_count),
            trawl_count    = sum(trawl_count),
            seine_count    = sum(seine_count),
            gillnet_count  = sum(gillnet_count))
  
spp_names <- read_csv(file.path(dir_o_anx, 'iucn', 'spp_info_from_api_2019-1.csv')) %>%
  select(iucn_sid, sciname) %>%
  distinct()

gear_threats <- fis_threat_sum %>%
  left_join(spp_names, by = 'iucn_sid') %>%
  left_join(gear_narr_sum, by = 'iucn_sid')

```

`r DT::datatable(gear_threats)`
