---
title: 'Matrix testing'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here::here('common_fxns.R'))

dir_bd_anx  <- '~/git-annex/bd_chi' ### this is on git-annex in home/ohara
dir_spp_anx <- '~/git-annex/spp_risk_dists'
dir_cons <- 'layers/cons_priorities'
dir_str  <- 'layers/stressors_10km'
```


# Summary

Trying out matrix techniques for this analysis.

# Methods

Bring in info on species presence (for a small handful of species), stressor presence (for a handful of stressors), convert these to matrices; create a stressor weight matrix.


Let $\mathbf X$ be an $n \times k$ matrix that maps species to cells, where $n$ is the number of species and $k$ is the number of cells.  Let $\mathbf Y$ be an $j \times k$ matrix that maps stressors to cells, where $j$ is the number of stressors.  Let $\mathbf W$ be an $n \times i$ matrix that provides stressor weights for each species.

### Species presence matrix

This is a little trickier because the species maps are saved as `.csvs` of `cell_id` and `presence`, rather than rasters including all cell values.  So: create an empty matrix with $n$ rows and $k$ columns, filled with zeroes, and for each species, fill that row in with 1s for each column associated with a cell ID.

```{r set up X matrix of species presence maps}
set.seed(12345)
n_spp <- 10
spp_rast_files <- list.files(file.path(dir_spp_anx, 'spp_rasts_mol_2019'),
                             full.names = TRUE) %>%
  sample(n_spp)

rast_base <- raster('_spatial/cell_id_mol.tif')

X <- matrix(data = 0, nrow = n_spp, ncol = ncell(rast_base))
rownames(X) <- basename(spp_rast_files) %>%
  str_extract('[0-9]+')

system.time({
for(i in seq_along(spp_rast_files)) {
  spp_map <- spp_rast_files[i]
  # cat('setting matrix row for ', basename(spp_map))
  
  spp_cells <- read_csv(spp_map) %>%
    filter(presence %in% 1:4)
  

  X[i, spp_cells$cell_id] <- 1
  
}
}) ### for 100 spp, elapsed 5.8 seconds with prints
dim(X)
```

#### Examine object size

Considering we want to do this for 7000+ maps, we need to be cognizant of the object size.  For the entire matrix (all cells), object size for 100 spp is ~5GB; filtered to ocean cells only, object size drops to ~3GB.  This, combined with memory required for a stressor matrix and processing, suggests we need to do this in chunks - taxonomic groups seems to make the most sense.

```{r}
ocean_rast <- raster('_spatial/ocean_area_mol.tif')

XX <- X[ , !is.na(values(ocean_rast))]

object.size(X); object.size(XX)

dim(X); dim(XX)

X <- XX
```

### Setting up stressor matrix

Set up a stressor matrix and stressor weight matrix.

```{r set up Y matrix of stressor maps}
n_str <- -1 ### sample from all maps: -1 means use all maps
str_rast_files <- list.files(dir_str, full.names = TRUE) 

if(n_str > 0) {
  str_rast_files <- str_rast_files %>%
    sample(n_str)
} else {
  n_str <- length(str_rast_files)
}

Y <- matrix(data = 0, nrow = n_str, ncol = ncell(rast_base))

basename(str_rast_files)
system.time({
for(i in seq_along(str_rast_files)) {
  # i <- 1
  str_rast <- raster(str_rast_files[i])
  str_rast[is.na(str_rast)] <- 0
  Y[i, ] <- values(str_rast)
}
})
dim(Y)
```

Compare object sizes for full stressor matrix (all cells) and ocean cells only.

```{r}
YY <- Y[ , !is.na(values(ocean_rast))]

object.size(Y); object.size(YY)
dim(Y); dim(YY)

Y <- YY
```

```{r set up W matrix}
### For testing, let's use a Poisson distribution to make up sample weights.
wts <- rpois(n = n_spp * n_str, lambda = 1)
W <- matrix(data = wts, nrow = n_spp, ncol = n_str)
```

### Set up sample vectors

To allow for single-species and single-stressor examples, let $\mathbf x$ be a $n \times 1$ vector mapping the presence of a single species, while $\mathbf y$ is a $k \times 1$ vector mapping the intensity of a single stressor, and $\mathbf w$ is an $i \times 1$ vector of stressor weights on a single species.

Let $\mathbf m$ can be a 1 $\times k$ vector of 1s and 0s denoting ocean status of each of $k$ cells (alternately, could be area?).  For $\mathbf x$ (and $\mathbf w$), use species 4 in this case, because a larger range; let's also use stressor 4 for $\mathbf y$.

```{r}
x <- X[4, ]
y <- Y[4, ]
w <- W[4, ]
m <- rep(1, length(x))
```

## Range area

Total area (by cells, easily converted to km^2^) of a species range (for species $spp$) is simply the sum of the presences in $\mathbf x$, noted by scalar $a_{spp}$:
$$a_{spp} = \mathbf x_{spp}^T \mathbf m$$
and area for all species is a $n \times 1$ vector:
$$\mathbf a = \mathbf X^T \mathbf m$$

```{r}
a <- x %*% m
a

A <- X %*% m
A
```


## Exposure to stressors

Total (unweighted) exposure $z$ of a given species $spp$ to given stressor $str$ is scalar:
$$z_{spp,str} = \mathbf x_{spp} \mathbf y_{str}^T$$
while total exposure of all species for all stressors is an $n \times i$ matrix:
$$\mathbf Z = \mathbf X \mathbf Y^T$$

```{r}
z <- x %*% y
z

Z <- X %*% t(Y)
Z

```

### Area of exposure

Area of a species' range exposed to a stressor would be found by the overlapping area of a normalized stressor matrix, i.e. stressor presence = 1 for any cell with stressor value > 0.  Divide that by the total range, and get the proportion of range for that species exposed to some level of that stressor.

```{r}
Y_norm <- Y
Y_norm[Y_norm > 0] <- 1

Z_area <- X %*% t(Y_norm)
Z_area

### divide the impact area by the total range
### is there a better way to do this?
Z_prop <- Z_area
for(i in 1:nrow(Z_area)) {
  # i <- 1
  Z_prop[i, ] <- Z_area[i, ] / A[i]
}

Z_prop %>% round(3)
```


## Cumulative impact to species

The cumulative impact of stressors upon a single species is the sum of stressors in each cell, weighted by the species' sensitivity to that stressor, and then multiplied by the exposure of that species to the 

### Cumulative weighted stressors

The cumulative weighted stressors $\mathbf q_{spp}$ upon a species for a vector of cells should be a $k \times 1$ vector that maps cumulative impact on a species, regardless of species presence.
$$\mathbf q_{spp} = \mathbf w_{spp} \mathbf Y$$
and for all species, an $n \times k$ matrix of cumulative weighted stressor for all species:
$$\mathbf Q = \mathbf W^T \mathbf Y$$

The cumulative impacts are then the species presence times the species cumulative weighted stressors, i.e. for a single species:
$$chi = \mathbf x \mathbf q^T$$
and across all species, the diagonal of the multiplied matrices:
$$CHI = \text{diag}(\mathbf X\mathbf Q^T)$$
```{r}
q <- w %*% Y

Q <- W %*% Y

chi <- x %*% t(q)

CHI <- diag(X %*% t(Q))

CHI
```

``` {r plot rasts}
x_rast <- q_rast <- y_rast <- rast_base

rebuild_rast <- function(x_vec, ocean_rast) {
  ### the x_vec is values for non-NA ocean cells
  x_vec <- as.vector(x_vec)
  x_rast <- ocean_rast
  values(x_rast)[!is.na(values(ocean_rast))] <- x_vec
  return(x_rast)
}
  

x_rast <- rebuild_rast(x, ocean_rast)
plot(x_rast, main = 'spp range map')
y_rast <- rebuild_rast(y, ocean_rast)
plot(y_rast, main = 'stressor intensity map')
q_rast <- rebuild_rast(q, ocean_rast)
plot(q_rast, main = 'weighted cumulative stressors')
  
cum_impact_rast <- q_rast * x_rast
plot(cum_impact_rast, main = 'cumulative impact on species')
cum_impact_sum <- sum(values(cum_impact_rast))

cum_impact_sum
```

