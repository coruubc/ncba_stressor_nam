---
title: 'Reproject stressors'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here::here('common_fxns.R'))

dir_str_mol <- '/home/shares/ohi/git-annex/impact_acceleration/stressors'
### this is an absolute path to git-annex on Mazu
dir_bd_anx <- '~/git-annex/bd_chi' ### this is on git-annex in home/ohara
dir_str_10km  <- here('layers/stressors_10km') ### relative path in github

```

# Summary

Collect stressor layers from CHI 2019 and reproject/aggregate them to the native resolution of the species range maps.  This will be done by mapping range map IDs to the cells in the Mollweide 934m resolution of the stressor layers, then converting to a data.frame to aggregate.

# Data Sources

Halpern et al. 2019.

# Methods

## Create cell ID lookup for spp CRS to chi CRS

Use the old ocean raster to identify the projection and resolution; reproject the cell_id raster to match, using nearest neighbor.

```{r}

cell_id_mol_file <- file.path(dir_bd_anx, 'spatial/cell_id_mol.tif')
ocean_mol_file <- file.path(dir_bd_anx, 'spatial/ocean_1km_mol.tif')
if(!file.exists(ocean_mol_file)) {
  file.copy(from = '/home/shares/ohi/model/GL-NCEAS-Halpern2008/tmp/ocean.tif',
            to = ocean_mol_file)
}

if(!file.exists(cell_id_mol_file)) {
  file.copy(from = '~/github/spp_risk_dists/_spatial/cell_id_mol.tif',
            to = ocean_mol_file)
}

ocean_area_rast <- raster('_spatial/ocean_area_mol.tif')
```

## Loop over all stressor layers, aggregate to spp CRS

Read in each raster (selecting only the latest year for each), aggregate to a raster at the species projection and resolution.  Because the projection is Mollweide for the source and target, and the base raster for species maps was created the same way, we can simply aggregate the original Mollweide CHI maps up by the same factor.  For spp maps, the aggregation factor was 11$\times$ to approximate 100 km^2^ cells: $.934 \times 11 = 10.28 \text{ km}; \; (.934 \times 11)^2 = 105.6633 \text{ km}^2$.

Note: here we are aggregating using mean value.

```{r}
### List directories that end in "final"
str_dirs <- list.files(dir_str_mol, recursive = TRUE, full.names = TRUE) %>%
  dirname() %>%
  unique() %>%
  .[str_detect(., 'final') & !str_detect(., 'archive')]
#  [1] "archive/art_fish/final"                 "archive/comm_fish/final/dem_dest"      
#  [3] "archive/comm_fish/final/dem_nondest_hb" "archive/comm_fish/final/dem_nondest_lb"
#  [5] "archive/comm_fish/final/pel_hb"         "archive/comm_fish/final/pel_lb"        
#  [7] "archive/sst_old/final"                  "art_fish/final"                        
#  [9] "benthic_structures/final"               "comm_fish/final/dem_dest"              
# [11] "comm_fish/final/dem_nondest_hb"         "comm_fish/final/dem_nondest_lb"        
# [13] "comm_fish/final/pel_hb"                 "comm_fish/final/pel_lb"                
# [15] "direct_human/final"                     "land_based/final/nutrient"             
# [17] "land_based/final/organic"               "light_pollution/final"                 
# [19] "oa/final"                               "shipping/final"                        
# [21] "slr/final"                              "sst/final"                             
# [23] "uv/final" 

for(dir in str_dirs) {
  ### dir <- str_dirs[2]
  files <- list.files(dir, pattern = '.tif$', full.names = TRUE)
  
  yrs_vec <- str_extract(files, '[0-9]{4}') %>% as.numeric()
  latest <- files[yrs_vec == max(yrs_vec)]
  
  str_10km_file <- file.path(dir_str_10km, 
                           str_replace(basename(latest), 'mol', 'mol10km'))
  
  if(!file.exists(str_10km_file)) {
    message('Processing ', basename(latest))
    str_rast_orig <- raster(latest)
    str_rast_10km <- raster::aggregate(str_rast_orig, 
                                       fact = 11, fun = mean,
                                       filename = str_10km_file,
                                       overwrite = TRUE)
    
    ### check to make sure results match spp rasts
    # raster::compareRaster(str_rast_10km, ocean_area_rast,
    #                       extent = TRUE, rowcol = TRUE, crs = TRUE, 
    #                       res = TRUE, orig = TRUE)
    ### TRUE!

  } else {
    message('File exists: ', str_10km_file, '... skipping!')
  }
}
```

```{r}
str_rasts_10km <- list.files(dir_str_10km, pattern = '.tif$', full.names = TRUE)
for(rast in str_rasts_10km) {
  tmp <- raster(rast)
  str_name <- basename(rast %>% str_replace('.tif', ''))
  plot(tmp, main = str_name)
}
```


