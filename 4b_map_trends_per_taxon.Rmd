---
title: 'Map trends per taxon'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

```


# Summary

Create taxa-level maps of number of species with intensifying or deintensifying impacts per cell, per year.

# Methods

* Gather species maps by taxonomic group (IUCN comprehensively assessed groups)
* read in all trend maps for all stressors, flatten to increasing/decreasing/indeterminate for each year
* add maps together for a taxa-level map of number of increasingly/decreasingly impacted species per cell

Individual stressor trend layers are clipped to their respective footprints based on the 95% contour volume applied to the 2013 stressor map.  Therefore, cells with a significant trend but no footprint are dropped.  In physical terms, this is a forward-looking approach, and means one of:

* cells with a stressor with decreasing trend, and below the threshold, have little room to continue decreasing - effectively the stressor is eliminated and can't get "better"
* cells with a stressor with an increasing trend, but still below the threshold, can't be increasing all that rapidly and do not seem to be a priority.

## Match threatened species to taxonomic groups per IUCN

Identify the species included in the impacted list (using the IUCN species IDs of impact map files, from prior scripts!).  Join this with the list of mapped species, to identify which taxonomic group the species is in (based on the downloaded IUCN shapefiles).  Taxa groups not represented in the impacted species list will be dropped.

```{r identify taxa groups}

### Get inclusion list; drop species with no sensitivities to stressors
spp_sens <- get_incl_spp() %>%
  filter(!is.na(stressor))

### directories for inputs
spp_range_dir <- file.path(dir_bd_anx, 'spp_rasts_mol_2020')

### directories for outputs
taxon_trend_map_dir <- file.path(dir_bd_anx, 'taxon_trend_rasts')
### unlink(file.path(taxon_trend_map_dir, '*.*'))

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

```

## Loop over taxonomic groups to create taxa-level impact maps

These maps count up the number of species with increasing impacts by the aggregated stressor group (land-based, ocean, climate, fishing, and all); similarly for species with decreasing impacts.

We will also map species trend counts using the priority weights from script 3b, i.e.
$$\text{priority} = \frac{\text{% range impacted}}{\ln (\text{spp range, km}^2)}$$
Note that priority is based on mean impact over last three impacted years.

For a given taxon:

* identify full list of impacted species
* select a subgroup (~10 spp) to process at a time
    * read in all spp in group
    * flatten all spp trend maps to increasing or decreasing or neutral
    * clip trend map to footprint for 2013
    * add all maps for each category group: by cell/year per stressor
    * also weight by priority values for each cell/year per stressor
* for all subgroups in a taxa, add them up.
    
```{r set up functions and dataframes}

get_spp_vec <- function(spp_ids, i, subgp_size) {
  gp_first <- (i - 1) * subgp_size + 1
  gp_last  <- min(i * subgp_size, length(spp_ids))
  spp_id_vec <- spp_ids[gp_first:gp_last]
}

get_spp_range <- function(spp_id) {
  range_map_filestem <- file.path(spp_range_dir, 'iucn_sid_%s.csv')
  rangemap <- read_csv(sprintf(range_map_filestem, spp_id),
                       col_types = 'ii') %>%
    mutate(iucn_sid = spp_id)
  return(rangemap)
}

get_str_footprint <- function() {
  ### This retrieves the stressor footprints for the 2013 year, and
  ### converts the rasters to a footprint dataframe of cell IDs
  message('Retrieving stressor footprints...')
  str_vec <- get_str_cats() %>%
    .$stressor
  ### set up file stem for stressor footprint rasters
  str_footprint_dir <- file.path(dir_bd_anx, 'layers/stressors_10km_95cv')
  str_ft_stem <- file.path(str_footprint_dir, '%s_2013_mol10km_95cv.tif')
    ### stressor - use 2013 footprint for clipping
  
  str_ft <- raster::stack(sprintf(str_ft_stem, str_vec))
  str_ft_df <- data.frame(values(str_ft)) %>%
    setNames(str_vec) %>%
    mutate(cell_id = 1:ncell(str_ft)) %>%
    gather(stressor, value, -cell_id) %>%
    filter(!is.na(value)) %>%
    select(-value)
  
  return(str_ft_df)
}

```

```{r create taxa maps}

### Trend files are rasters of value (trend slope) and p_val.
pace_df <- read_csv(file.path(dir_bd_anx, 'layers/stressor_pace.csv')) %>%
  filter(!is.na(pace)) %>%
  select(cell_id, stressor, pace)

### load priorities; normalize so max priority = 1.
priority_df <- read_csv(here('_output/spp_priority.csv')) %>%
  mutate(priority = priority / max(priority)) %>%
  select(iucn_sid, priority)

### get the stressor footprints for 2013 as a dataframe
str_ft_df <- get_str_footprint()

str_cats <- c('land-based', 'ocean', 'fishing', 'climate', 'all')
taxon_gps <- spp_sens$taxon %>% unique() %>% sort()

subgp_size <- 24 ### number of spp to process at a time
reload <- FALSE

for(str_cat in str_cats) {
  # str_cat <- str_cats[4]
  
  for(taxon_gp in taxon_gps) {
    ### taxon_gp <- taxon_gps[2]
    
    tx_incr_f <- file.path(taxon_trend_map_dir,
      sprintf('taxon_trend_%s_%s_incr.tif', taxon_gp, str_cat))
    tx_pr_incr_f <- file.path(taxon_trend_map_dir, 
      sprintf('taxon_priority_trend_%s_%s_incr.tif', taxon_gp, str_cat))
    tx_decr_f <- file.path(taxon_trend_map_dir, 
      sprintf('taxon_trend_%s_%s_decr.tif', taxon_gp, str_cat))
    tx_pr_decr_f <- file.path(taxon_trend_map_dir, 
      sprintf('taxon_priority_trend_%s_%s_decr.tif', taxon_gp, str_cat))
    
    if(any(!file.exists(tx_incr_f, tx_decr_f, tx_pr_incr_f, tx_pr_decr_f)) | reload) {
      spp_ids_taxa <- spp_sens %>%
        filter(taxon == taxon_gp) %>%
        filter(str_cat == 'all' | category == str_cat) %>%
        .$iucn_sid %>% 
        unique() %>% sort()
      
      n_subgps <- ceiling(length(spp_ids_taxa) / subgp_size)
      message('Processing ', str_cat, ' impacts for ', taxon_gp, 
              ': ', length(spp_ids_taxa), 
              ' species broken into ', n_subgps, ' groups.')
      
      if(length(spp_ids_taxa) == 0) {
        ### uh oh, no species in this taxon affected by this stressor.
        taxon_trend_df <- data.frame()
      } else {
        ### loop over all spp in this taxon affected by this stressor
        ### initialize a list to store 
        taxon_trend_list <- vector('list', length = n_subgps)
        for(i in 1:n_subgps) {
          # i <- 1
          message('  processing group ', i)
          spp_id_vec <- get_spp_vec(spp_ids_taxa, i, subgp_size)
          
          spp_gp_sens <- spp_sens %>%
            filter(iucn_sid %in% spp_id_vec) %>%
            filter(str_cat == 'all' | category == str_cat) %>%
            select(iucn_sid, stressor) %>%
            distinct()
            
          spp_ranges <- parallel::mclapply(
            spp_id_vec,
            FUN = get_spp_range,
            mc.cores = subgp_size) %>%
            bind_rows()
          
          trend_gp <- spp_ranges %>%
            left_join(spp_gp_sens, by = 'iucn_sid') %>%
            # left_join(pace_df, by = 'cell_id')
            dt_join(pace_df, by = c('cell_id', 'stressor'), type = 'inner') %>%
              ### inner join drops non-intensifying/deintensifying cells
            dt_join(priority_df, by = 'iucn_sid', type = 'left') %>%
            dt_join(str_ft_df, by = c('cell_id', 'stressor'), type = 'inner')
              ### inner join drops all cells where stressor is not "present"
              ### according to 95% contour volume
          
          trend_gp_summary <- trend_gp %>%
            group_by(cell_id, iucn_sid, priority) %>%
            summarize(incr = any(pace == +1) & !any(pace == -1),
                      decr = any(pace == -1) & !any(pace == +1)) %>%
            group_by(cell_id) %>%
            summarize(priority_incr_spp = sum(priority * incr),
                      priority_decr_spp = sum(priority * decr),
                      n_incr_spp = sum(incr),
                      n_decr_spp = sum(decr)) %>%
            ungroup()
          
          taxon_trend_list[[i]] <- trend_gp_summary
        } ### end of for loop
        
      ### collate all the list element dataframes
      taxon_trend_df <- bind_rows(taxon_trend_list) %>%
        group_by(cell_id) %>%
        summarize(priority_incr_spp = sum(priority_incr_spp, na.rm = TRUE),
                  priority_decr_spp = sum(priority_decr_spp, na.rm = TRUE),
                  n_incr_spp = sum(n_incr_spp, na.rm = TRUE),
                  n_decr_spp = sum(n_decr_spp, na.rm = TRUE)) %>%
        ungroup() %>%
        mutate(taxon = taxon_gp)
      
      } ### end of if statement for zero-length species vector
      
      if(nrow(taxon_trend_df) == 0) {
        ### either no species in the list, or no trend for any of the spp
        taxon_trend_df <- data.frame(cell_id = NA,
                                     priority_incr_spp = NA,
                                     priority_decr_spp = NA,
                                     n_incr_spp = NA,
                                     n_decr_spp = NA,
                                     taxon   = taxon_gp)
      }
      
      ### convert to rasters and write out as +/- by count and priority

      nspp_incr_rast <- map_to_rast(taxon_trend_df, cell_val = 'n_incr_spp')
      nspp_decr_rast <- map_to_rast(taxon_trend_df, cell_val = 'n_decr_spp')
      priority_incr_rast <- map_to_rast(taxon_trend_df, cell_val = 'priority_incr_spp')
      priority_decr_rast <- map_to_rast(taxon_trend_df, cell_val = 'priority_decr_spp')
      
      writeRaster(nspp_incr_rast, tx_incr_f, overwrite = TRUE)
      writeRaster(nspp_decr_rast, tx_decr_f, overwrite = TRUE)
      writeRaster(priority_incr_rast, tx_pr_incr_f, overwrite = TRUE)
      writeRaster(priority_decr_rast, tx_pr_decr_f, overwrite = TRUE)
      
    } else {
      message('Files exist... skipping!')
    }
  }
}
```

## Plot select taxa trend maps 

Plot taxa maps species experiencing intensifying/deintensifying impacts.  Here we plot only the trends for fishing stressors, climate stressors, and all cumulative stressors, for a subset of taxa.  We plot the count only (not priority-weighted).

```{r trend maps by taxa, eval = TRUE}

nspp_rast <- raster(here('_output/rasters/n_spp_map.tif'))
mapfiles <- list.files(taxon_trend_map_dir, full.names = TRUE)

strs <- c('fishing', 'climate', 'all')
taxa <- c('sea_turtles', 'mammals', 'birds', 'sharks_and_rays')

for(str_cat in strs) {
  # str_cat <- strs[1]
  for(t in taxa) {
    # t <- taxa[3]
    fstem <- file.path(taxon_trend_map_dir, 'taxon_trend_%s_%s_%s.tif')
    
    incr_map <- raster(sprintf(fstem, t, str_cat, 'incr')) / nspp_rast
    plot(incr_map, 
         col = c('grey70', hcl.colors(n = 20, rev = TRUE)),
         main = sprintf('intensifying %s impacts, %s', str_cat, t))
    
    decr_map <- raster(sprintf(fstem, t, str_cat, 'decr')) / nspp_rast
    plot(decr_map, 
         col = c('grey70', hcl.colors(n = 20, rev = TRUE)),
         main = sprintf('deintensifying %s impacts, %s', str_cat, t))
    
    overlap <- raster(incr_map)
    values(overlap)[values(incr_map) > 0 & values(decr_map) > 0] <- 1
    plot(overlap, 
         col = 'darkred',
         main = sprintf('overlapping incr and decr %s, %s', str_cat, t))
  }
}
```
