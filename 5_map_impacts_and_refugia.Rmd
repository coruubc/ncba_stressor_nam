---
title: 'Map impacts for all impacted species'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

library(animation)

reload <- FALSE
```


# Summary

Create a species richness map for only the species included in this assessment.

Combine taxa-level impact and refugia maps to create maps of number of species impacted per cell, per year, and species in refugia (i.e., zero impact) per cell, per year.

Plot maps as animated rasters, both by absolute numbers of species impacted in a location and by proportion of species.

# Methods

## Create species richness map for this assessment

Set up the dataframe of species to include.  By taxon, load all species range maps, smash down to taxon-level species richness; then combine these for a total species richness.

```{r Identify species in this assessment}

### Load spp info for sensitivity, risk, comprehensive status, and maps
spp_sens <- read_csv(here('_output', sprintf('spp_sensitivity_%s.csv', api_version)),
                     col_types = cols('iucn_sid' = 'i'))
spp_risk <- read_csv(here('_data', sprintf('iucn_risk_current_%s.csv', api_version)),
                     col_types = cols('iucn_sid' = 'i'))
spp_maps <- read_csv(here('_data', sprintf('spp_marine_maps_%s.csv', api_version))) %>%
  filter(presence != 5) %>%
  .$iucn_sid %>%
  unique()
spp_comp <- read_csv(here('_data', sprintf('iucn_comp_assessed_%s.csv', api_version))) %>%
  select(-sciname)

### Combine to make a species list that includes species that are:
### * threatened or near threatened
### * included in a comprehensively-assessed taxon
### * mapped
###
### NOTE: for comparing pct of threatened spp that are impacted, we will look
### at ALL threatened/mapped/comprehensive spp, not just those with one or
### more sensitivities!

spp_incl <- spp_risk %>%
  filter(!is.na(cat_score) & !cat_score %in% c(0, 1)) %>%
  filter(iucn_sid %in% spp_maps) %>%
  left_join(spp_comp, by = c('iucn_sid')) %>%
  filter(!is.na(taxon))

# spp_incl$iucn_sid %>% n_distinct()
### 1255 if we limit to just sensitive spp, 1357 if we include all
### mapped/threatened/comp assessed spp
```

```{r map to raster function}
cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

map_to_rast <- function(map_df, cell_val = 'n_spp') {
  # map_rast <- raster::subs(cell_id_rast, as.data.frame(map_df), 
  #                          by = 'cell_id', which = val)
  map_rast <- raster(cell_id_rast)
  values(map_rast)[map_df$cell_id] <- map_df[[cell_val]]
  return(map_rast)
}
```

``` {r create species richness map}
spp_rich_mapfile <- here('_output/n_spp_map.tif')
if(!file.exists(spp_rich_mapfile) | reload) {
  
  spp_range_dir <- file.path(dir_bd_anx, 'spp_rasts_mol_2020')
  
  taxa_gps <- spp_incl$taxon %>% unique() %>% sort()
  
  taxa_map_list <- vector('list', length = length(taxa_gps))
  for(i in seq_along(taxa_gps)) {
    # i <- 2
    taxa_gp <- taxa_gps[i]
    spp_ids_taxa <- spp_incl %>%
      filter(taxon == taxa_gp) %>%
      .$iucn_sid %>%
      unique()
    
    map_list <- parallel::mclapply(spp_ids_taxa,
      FUN = function(id) {
        # id <- spp_ids_taxa[1]
        spp_f <- file.path(spp_range_dir, sprintf('iucn_sid_%s.csv', id))
        spp_df <- read_csv(spp_f, col_types = 'ii') %>%
          mutate(iucn_sid = id) %>%
          mutate(present = (presence != 5) & !is.na(presence))
      })
    map_df <- bind_rows(map_list)
    map_nspp_df <- map_df %>%
      group_by(cell_id) %>%
      summarize(n_spp = sum(present))
    taxa_map_list[[i]] <- map_to_rast(map_nspp_df)
  }
  
  taxa_map_stack <- stack(taxa_map_list)
  spp_rich_rast <- raster::calc(taxa_map_stack, 
                                fun = sum, na.rm = TRUE) %>%
    mask(ocean_a_rast)
  
  writeRaster(spp_rich_rast, spp_rich_mapfile)
}

spp_rich_rast <- raster(spp_rich_mapfile)
plot(spp_rich_rast, main = 'Species richness')

```


## Setup for mapping across all taxa

For each combination of climate/no climate and impacts/refugia:

* gather all taxa-level map files into a raster stack
* collapse the stack using `calc(fun = sum, na.rm = TRUE)`
* animate over the years

```{r identify taxa map files}
spp_range_dir <- file.path(dir_bd_anx, 'spp_rasts_mol_2020')

taxon_impact_map_dir <- file.path(dir_bd_anx, 'taxon_impact_rasts')
taxon_refugia_map_dir <- file.path(dir_bd_anx, 'taxon_refugia_rasts')

all_maps <- list.files(c(taxon_impact_map_dir, taxon_refugia_map_dir),
                       pattern = '.tif',
                       full.names = TRUE)
taxa_map_df <- data.frame(map = all_maps) %>%
  mutate(year   = str_extract(basename(map), '[0-9]{4}') %>% as.integer(),
         type   = ifelse(str_detect(map, 'impact'), 'impact', 'refugia'),
         impact = ifelse(str_detect(map, 'no_cc'), 'non-climate', 'climate'))
```


```{r animate function}
make_ramp <- function(n, palette) {
  if(n > 101) {
    n_even <- round(n + 50, -2)
    breaks <- seq(.5, n_even, length.out = 100)
    labels <- seq(0, n_even, by = 100)
  } else {
    n_even <- n
    breaks <- seq(min(0.5, n / 100), n, length.out = 100)
    labels <- seq(0, n, by = (n / 10))
  }
  colors <- hcl.colors(length(breaks), palette = palette)
  
  ### For breaks and colors, add a different color for 
  ### a value of exactly zero
  return(list('colors' = c('grey40', colors),
              'breaks' = c(0, breaks),
              'labels' = labels))
}

make_gifs <- function(map_stack, filename, layer_names = NULL) {
  if(is.null(layer_names)) layer_names = names(map_stack)
  
  ramp <- make_ramp(max(maxValue(map_stack)), palette = 'viridis')
  
  capture.output({
    saveGIF({
      for(i in 1:nlayers(map_stack)){
        plot(map_stack[[i]], 
             col = ramp$colors,
             breaks = ramp$breaks,
             axes = FALSE,
             axis.args = list(at = ramp$labels),
             main = layer_names[i])
      }}, 
      interval = 0.5, movie.name = filename, 
      ani.width = 700, ani.height = 420)
  })
  
  return(invisible(NULL))
}

nspp_rast <- spp_rich_rast
values(nspp_rast)[values(nspp_rast) == 0] <- NA
```

## Create impact map for all included spp, non-climate

```{r impact all non-climate}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'non-climate' & type == 'impact')
outfile_stem <- here('_output/impact_map_%s_no_cc.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/impact_no_cc.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files)
  
  make_gifs(map_stack, 
            filename = gif_file,
            layer_names = paste('Non-climate impacts', yrs))
}

knitr::include_graphics(gif_file)
```

``` {r}
### Animate the results
gif_file <- here('figs/impact_pct_no_cc.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files) 
  x <- map_stack / nspp_rast
  values(x)[values(x) > 1] <- 1
  x <- x * 100
  
  make_gifs(x, 
            filename = gif_file,
            layer_names = paste('Non-climate impacts pct', yrs))
}

knitr::include_graphics(gif_file)
```

## Create impact map for all included spp, climate only

```{r impact all cc only}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'climate' & type == 'impact')
outfile_stem <- here('_output/impact_map_%s_cc_only.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/impact_cc_only.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files)
  
  make_gifs(map_stack, 
            filename = gif_file,
            layer_names = paste('Climate impacts', yrs))
}

knitr::include_graphics(gif_file)
```

``` {r}
### Animate the results
gif_file <- here('figs/impact_pct_cc_only.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files) 
  x <- map_stack / nspp_rast * 1
  values(x)[values(x) > 1] <- 1
  x <- x * 100
  
  make_gifs(x, 
            filename = gif_file,
            layer_names = paste('Climate impacts pct', yrs))
}

knitr::include_graphics(gif_file)
```

## Create refugia map for all included spp, non-climate

```{r refugia map all non-climate}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'non-climate' & type == 'refugia')
outfile_stem <- here('_output/refugia_map_%s_no_cc.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/refugia_no_cc.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files)
  
  make_gifs(map_stack, 
            filename = gif_file,
            layer_names = paste('Non-climate refugia', yrs))
}

knitr::include_graphics(gif_file)
```

``` {r}
### Animate the results
gif_file <- here('figs/refugia_pct_no_cc.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files) 
  z <- map_stack / nspp_rast
  values(z)[values(z) > 1] <- 1
  z <- z * 100
  
  make_gifs(z, 
            filename = gif_file,
            layer_names = paste('Non-climate refugia pct', yrs))
}

knitr::include_graphics(gif_file)
```


## Create refugia map for all included spp, climate only

```{r refugia map all climate only}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'climate' & type == 'refugia')
outfile_stem <- here('_output/refugia_map_%s_cc_only.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/refugia_cc_only.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files)
  
  make_gifs(map_stack, 
            filename = gif_file,
            layer_names = paste('Climate refugia', yrs))
}

knitr::include_graphics(gif_file)
```

``` {r}
### Animate the results
gif_file <- here('figs/refugia_pct_cc_only.gif')

if(!file.exists(gif_file) | reload) {
  rast_files <- sprintf(outfile_stem, yrs)
  map_stack <- stack(rast_files) 
  x <- map_stack / nspp_rast * 1
  values(x)[values(x) > 1] <- 1
  x <- x * 100
  
  make_gifs(x, 
            filename = gif_file,
            layer_names = paste('Climate refugia pct', yrs))
}

knitr::include_graphics(gif_file)
```

