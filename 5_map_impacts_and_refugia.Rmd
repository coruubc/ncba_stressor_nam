---
title: 'Map impacts for all impacted species'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

library(animation)

reload <- FALSE
```


# Summary

Combine taxa-level impact and refugia maps to create maps of number of species impacted per cell, per year, and species in refugia (i.e., zero impact) per cell, per year.

# Methods

For each combination of climate/no climate and impacts/refugia:

* gather all taxa-level map files into a raster stack
* collapse the stack using `calc(fun = sum, na.rm = TRUE)`
* animate over the years

```{r identify taxa map files}
spp_range_dir <- file.path(dir_bd_anx, 'spp_rasts_mol_2019')

taxon_impact_map_dir <- file.path(dir_bd_anx, 'taxon_impact_rasts')
taxon_refugia_map_dir <- file.path(dir_bd_anx, 'taxon_refugia_rasts')

all_maps <- list.files(c(taxon_impact_map_dir, taxon_refugia_map_dir),
                       pattern = '.tif',
                       full.names = TRUE)
taxa_map_df <- data.frame(map = all_maps) %>%
  mutate(year   = str_extract(basename(map), '[0-9]{4}') %>% as.integer(),
         type   = ifelse(str_detect(map, 'impact'), 'impact', 'refugia'),
         impact = ifelse(str_detect(map, 'no_cc'), 'non-climate', 'climate'))
```


```{r animate function}
make_ramp <- function(n, palette) {
  n_even <- round(n + 50, -2)
  breaks <- seq(1, n_even, length.out = 100)
  labels <- seq(0, n_even, by = 100)
  colors <- hcl.colors(length(breaks), palette = palette)
  
  ### For breaks and colors, add a different color for 
  ### a value of exactly zero
  return(list('colors' = c('grey40', colors),
              'breaks' = c(0, breaks),
              'labels' = labels))
}

make_gifs <- function(map_stack, filename, layer_names = NULL) {
  if(is.null(layer_names)) layer_names = names(map_stack)
  
  ramp <- make_ramp(max(maxValue(map_stack)), palette = 'viridis')
  
  capture.output({
    saveGIF({
      for(i in 1:nlayers(map_stack)){
        plot(map_stack[[i]], 
             col = ramp$colors,
             breaks = ramp$breaks,
             axes = FALSE,
             axis.args = list(at = ramp$labels),
             main = layer_names[i])
      }}, 
      interval = 0.5, movie.name = filename, 
      ani.width = 700, ani.height = 500)
  })
  
  return(invisible(NULL))
}
```

## Create impact map for all included spp, non-climate

```{r}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'non-climate' & type == 'impact')
outfile_stem <- here('_output/impact_map_%s_no_cc.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/impact_no_cc.gif')
rast_files <- sprintf(outfile_stem, yrs)
map_stack <- stack(rast_files)

make_gifs(map_stack, 
          filename = gif_file,
          layer_names = paste('Non-climate impacts', yrs))

knitr::include_graphics(gif_file)
```


## Create impact map for all included spp, climate only

```{r}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'climate' & type == 'impact')
outfile_stem <- here('_output/impact_map_%s_cc_only.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/impact_cc_only.gif')
rast_files <- sprintf(outfile_stem, yrs)
map_stack <- stack(rast_files)

make_gifs(map_stack, 
          filename = gif_file,
          layer_names = paste('Climate impacts', yrs))

knitr::include_graphics(gif_file)
```

## Create refugia map for all included spp, non-climate

```{r}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'non-climate' & type == 'refugia')
outfile_stem <- here('_output/refugia_map_%s_no_cc.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/refugia_no_cc.gif')
rast_files <- sprintf(outfile_stem, yrs)
map_stack <- stack(rast_files)

make_gifs(map_stack, 
          filename = gif_file,
          layer_names = paste('Non-climate refugia', yrs))

knitr::include_graphics(gif_file)
```


## Create refugia map for all included spp, climate only

```{r}

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

impact_map_files <- taxa_map_df %>%
  filter(impact == 'climate' & type == 'refugia')
outfile_stem <- here('_output/refugia_map_%s_cc_only.tif')

yrs <- 2003:2013

for(y in yrs) {
  # y <- 2003
  
  outfile <- sprintf(outfile_stem, y)
  
  if(!file.exists(outfile) | reload) {
    imp_yr_files <- impact_map_files %>%
      filter(year == y) %>%
      .$map
    impact_yr_stack <- stack(imp_yr_files)
    impact_yr_rast <- raster::calc(impact_yr_stack, fun = sum, na.rm = TRUE) %>%
      mask(ocean_a_rast)
    
    writeRaster(impact_yr_rast, outfile, overwrite = TRUE)
    
  } else {
    message('File exists: ', outfile, '... skipping!')
  }
}

```

``` {r}
### Animate the results
gif_file <- here('figs/refugia_cc_only.gif')
rast_files <- sprintf(outfile_stem, yrs)
map_stack <- stack(rast_files)

make_gifs(map_stack, 
          filename = gif_file,
          layer_names = paste('Climate refugia', yrs))

knitr::include_graphics(gif_file)
```


