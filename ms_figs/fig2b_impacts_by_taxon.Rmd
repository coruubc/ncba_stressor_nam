---
title: 'Plot impacts by taxon'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

# library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

reload <- FALSE
```


# Summary

In taxonomic groups (class level) summarize the impacted footprint and intensifying footprint across all species in the group, based on the cumulative suite of all possible stressors.  We will summarize distributions of:

* % range impacted by 1 or more stressors
* % range impacted by 2 or more stressors and 3 or more stressors?
    * limit to species with sensitivity to multiple stressors
* % range impacted by intensifying stressors
* % range impacted by deintensifying stressors

# Methods

First we must generate a lookup table for taxonomic groups divorced from the IUCN's classifications - i.e. group all bony fishes together.  Then for each group, pull in the set of species-level impact summaries to calculate summaries.

## Assign taxa by class

```{r}
spp_incl <- get_incl_spp()

spp_sens <- spp_incl %>%
  filter(!is.na(stressor))

spp_info <- read_csv(file.path(dir_bd_anx, 'iucn', 
                               'spp_info_from_api_2020-1.csv')) %>%
  select(iucn_sid, sciname, kng = kingdom, phy = phylum, cls = class)

spp_sens_class <- spp_sens %>%
  select(iucn_sid) %>%
  left_join(spp_info, by = c('iucn_sid')) %>%
  mutate(cls = tools::toTitleCase(tolower(cls))) %>%
  distinct()

write_csv(spp_sens_class, here('int/spp_class.csv'))

spp_class_summary <- spp_sens_class %>%
  mutate(nspp_tot = n_distinct(iucn_sid)) %>%
  group_by(kng, phy, cls) %>%
  summarize(nspp_tot = first(nspp_tot),
            nspp_tax = n_distinct(iucn_sid))

knitr::kable(spp_class_summary)
```

## Gather species-level summaries by taxon

```{r}
taxon_df <- get_spp_taxon()

spp_sum_list <- parallel::mclapply(spp_sens_class$iucn_sid,
    FUN = function(iucn_sid) {
      # iucn_sid <- spp_sens_gp$iucn_sid[1]
      fstem <- file.path(dir_bd_anx, 'spp_impacts', 'spp_impacts_%s_all.csv')
      x <- read_csv(sprintf(fstem, iucn_sid))
      return(x)
    }, mc.cores = 24)

spp_sum_df <- spp_sum_list %>%
  bind_rows() %>%
  filter(year == 2013 | is.na(year)) %>%
  group_by(iucn_sid) %>%
  mutate(n_str = n_distinct(stressor) - 1) %>%
  ungroup() %>%
  filter(stressor == 'cumulative') %>%
  mutate(pct_imp = impact_km2 / range_km2,
         pct_imp2 = ifelse(n_str > 1, impact_2plus_km2 / range_km2, NA),
         pct_imp3 = ifelse(n_str > 2, impact_3plus_km2 / range_km2, NA),
         pct_incr = incr_km2 / range_km2,
         pct_decr = decr_km2 / range_km2) %>%
  left_join(spp_sens_class, by = 'iucn_sid') %>%
  select(iucn_sid, stressor, starts_with('pct'), 
         n_str, range_km2, 
         kng, phy, cls)

tax_sum_df <- spp_sum_df %>%
  group_by(kng, phy, cls) %>%
  summarize(mean_pct_imp  = mean(pct_imp, na.rm = TRUE),
            sd_pct_imp    = sd(pct_imp, na.rm = TRUE),
            mean_pct_imp2 = mean(pct_imp2, na.rm = TRUE),
            mean_pct_imp3 = mean(pct_imp3, na.rm = TRUE),
            mean_pct_incr = mean(pct_incr, na.rm = TRUE),
            sd_pct_incr   = sd(pct_incr, na.rm = TRUE),
            mean_pct_decr = mean(pct_decr, na.rm = TRUE),
            sd_pct_decr   = sd(pct_decr, na.rm = TRUE),
            mean_n_str    = mean(n_str),
            sd_n_str      = sd(n_str),
            mean_range_km2 = mean(range_km2),
            sd_range_km2  = sd(range_km2)) %>%
  ungroup()

all_sum_df <- spp_sum_df %>%
  # group_by(kng, phy, cls) %>%
  summarize(cls = 'All threatened spp',
            mean_pct_imp  = mean(pct_imp, na.rm = TRUE),
            sd_pct_imp    = sd(pct_imp, na.rm = TRUE),
            mean_pct_imp2 = mean(pct_imp2, na.rm = TRUE),
            mean_pct_imp3 = mean(pct_imp3, na.rm = TRUE),
            mean_pct_incr = mean(pct_incr, na.rm = TRUE),
            sd_pct_incr   = sd(pct_incr, na.rm = TRUE),
            mean_pct_decr = mean(pct_decr, na.rm = TRUE),
            sd_pct_decr   = sd(pct_decr, na.rm = TRUE),
            mean_n_str    = mean(n_str),
            sd_n_str      = sd(n_str),
            mean_range_km2 = mean(range_km2),
            sd_range_km2  = sd(range_km2)) %>%
  ungroup()
  
plot_tax_sum_df <- tax_sum_df %>%
  arrange(desc(kng), mean_pct_imp) %>%
  bind_rows(all_sum_df) %>%
  mutate(cls = fct_inorder(cls)) %>%
  mutate(mean_pct_nochange = mean_pct_imp - mean_pct_decr - mean_pct_incr) %>%
  gather(var, val, mean_pct_incr, mean_pct_decr, mean_pct_nochange) %>%
  mutate(var = factor(var, levels = c('mean_pct_incr', 
                                      'mean_pct_nochange', 
                                      'mean_pct_decr')))
  
plot_spp_sum_df <- spp_sum_df %>%
  gather(var, val, pct_incr, pct_decr, pct_imp)
```

```{r}
ggplot(plot_spp_sum_df) +
  ggtheme_plot() +
  geom_point(aes(x = range_km2, y = val, color = var)) +
  scale_x_log10()
  # facet_wrap( ~ class, ncol = 1, strip.position = 'left')

ggplot(plot_tax_sum_df) +
  ggtheme_plot() +
  geom_col(aes(x = cls, y = val, fill = var), 
           show.legend = FALSE) +
  labs(y = 'Pct range impacted') +
  scale_fill_manual(values = c('red3', 'grey80', 'green4')) +
  coord_flip() +
  theme(axis.title.y = element_blank())
```

