---
title: 'Fig 1: impacts and intensification maps'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(sf)
library(cowplot)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

reload <- FALSE
```


# Summary

Create figure 1 for manuscript.  1A: map of impacted species by pct; 1B: map of intensification by pct.

# Methods

## Fig. 1A

Load rasters of impacted spp for 2013; make a cool map.

``` {r figure 1a}

imp_count  <- raster(here('_output/rasters/impact_maps/impact_all_2013.tif'))

xfm <- function(x) log10(x) ### how are we transforming count?

imp_ct_df <- rasterToPoints(imp_count) %>%
  as.data.frame() %>%
  setNames(c('x', 'y', 'imp_ct')) %>%
  mutate(xfm_imp_ct = xfm(imp_ct))

max_ct <- max(imp_ct_df$imp_ct, na.rm = TRUE)
ct_labels <- c(1, 10, 100, max_ct)
ct_breaks <- xfm(ct_labels)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(crs(imp_count))

fig1a_impact_ct_map <- ggplot() +
  ggtheme_map(base_size = 7) +
  geom_raster(data = imp_ct_df, aes(x, y, fill = xfm_imp_ct)) +
  geom_sf(data = land_sf, fill = 'grey96', color = 'grey40', size = .10) +
  scale_fill_viridis_c(breaks = ct_breaks,
                       labels = ct_labels,
                       na.value = 'grey80') +
  theme(plot.margin = unit(c(.05, 0, .05, 0), units = 'cm'),
        legend.background = element_blank(),
        legend.key.width = unit(.25, 'cm'),
        legend.title = element_blank()) +
  coord_sf(datum = NA) + ### ditch graticules
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))

# fig1a_impact_ct_map

```

## Fig. 1B

Load rasters of impacted spp and species count for 2013; generate impacted spp by pct; make a cool map.

``` {r figure 1b}
imp_count  <- raster(here('_output/rasters/impact_maps/impact_all_2013.tif'))
nspp <- raster(here('_output/rasters/n_spp_map.tif')) 

imp_pct <- imp_count / nspp

imp_pct_df <- rasterToPoints(imp_pct) %>%
  as.data.frame() %>%
  rename(imp_pct = layer)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(crs(imp_pct))

fig1b_impact_pct_map <- ggplot() +
  ggtheme_map(base_size = 7) +
  geom_raster(data = imp_pct_df, aes(x, y, fill = imp_pct)) +
  geom_sf(data = land_sf, fill = 'grey96', color = 'grey40', size = .10) +
  scale_fill_viridis_c(breaks = seq(0, 1, .25), 
                       labels = paste0(seq(0, 100, 25), '%'),
                       na.value = 'grey80') +
  theme(plot.margin = unit(c(.05, 0, .05, 0), units = 'cm'),
        legend.background = element_blank(),
        legend.key.width = unit(.25, 'cm'),
        legend.title = element_blank()) +
  coord_sf(datum = NA) + ### ditch graticules
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))

# print(fig1b_impact_pct_map)

```

## Fig. 1C

Load rasters of intensification by count and species count for 2013; generate intensifying spp by pct; make a cool map.

``` {r figure 1c}
incr <- raster(here('_output/rasters/intens_maps/intens_all_incr2.tif'))
decr <- raster(here('_output/rasters/intens_maps/intens_all_decr2.tif'))
nspp <- raster(here('_output/rasters/n_spp_map.tif')) 

int_pct <- (incr - decr) / nspp

int_pct_df <- rasterToPoints(int_pct) %>%
  as.data.frame() %>%
  rename(int_pct = layer)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(crs(int_pct))

fig1c_intens_pct_map <- ggplot() +
  ggtheme_map(base_size = 7) +
  geom_raster(data = int_pct_df, aes(x, y, fill = int_pct), size = .1) +
  geom_sf(data = land_sf, fill = 'grey96', color = 'grey40', size = .10) +
  scale_fill_gradient2(low = '#4dac26', mid = '#f7f7f7', high = '#d01c8b',
                    breaks = seq(-1, 1, .5), 
                    labels = paste0(seq(-100, 100, 50), '%'),
                    na.value = 'grey80') +
  theme(plot.margin = unit(c(.05, 0, .05, 0), units = 'cm'),
        legend.background = element_blank(),
        legend.key.width = unit(.25, 'cm'),
        legend.title = element_blank()) +
  coord_sf(datum = NA) + ### ditch graticules
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))

# fig1c_intens_pct_map

```

## Combine into one figure

```{r}
fig1_file <- here('ms_figs/fig1_impact_intensification.png')

if(!file.exists(fig1_file)) {
  fig1a_panel  <- get_panel(fig1a_impact_ct_map)
  fig1b_panel  <- get_panel(fig1b_impact_pct_map)
  fig1c_panel  <- get_panel(fig1c_intens_pct_map)
  fig1a_legend <- get_legend(fig1a_impact_ct_map)
  fig1b_legend <- get_legend(fig1b_impact_pct_map)
  fig1c_legend <- get_legend(fig1c_intens_pct_map)
  
  fig1 <- ggdraw() +
    draw_plot(fig1a_panel,  x = .01, y = 0.67, width = .88, height = .32) +
    draw_plot(fig1b_panel,  x = .01, y = 0.34, width = .88, height = .32) +
    draw_plot(fig1c_panel,  x = .01, y = 0.01, width = .88, height = .32) +
    draw_plot(fig1a_legend, x = .89, y = 0.67, width = .1, height = .32) +
    draw_plot(fig1b_legend, x = .895, y = 0.34, width = .1, height = .32) +
    draw_plot(fig1c_legend, x = .9, y = 0.00, width = .1, height = .32) +
    draw_label('A', x = .05, y = .95, vjust = 1, size = 9, color = 'grey20', fontface = 'bold') +
    draw_label('B', x = .05, y = .62, vjust = 1, size = 9, color = 'grey20', fontface = 'bold') +
    draw_label('C', x = .05, y = .30, vjust = 1, size = 9, color = 'grey20', fontface = 'bold') +
    draw_label('Species impacted\n(count)', x = .93, y = .97, hjust = 1, vjust = 1, 
               size = 7, color = 'grey20', fontface = 'bold') +
    draw_label('Species impacted\n(percent)', x = .93, y = .64, hjust = 1, vjust = 1, 
               size = 7, color = 'grey20', fontface = 'bold') +
    draw_label('Intensification\n(percent)', x = .93, y = .30, hjust = 1, vjust = 1, 
               size = 7, color = 'grey20', fontface = 'bold')
    
  ggsave(plot = fig1, filename = fig1_file,
         height = 15, width = 12, units = 'cm', dpi = 300)
}

knitr::include_graphics(fig1_file)
# unlink(fig1_file)
```

