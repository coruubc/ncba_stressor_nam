---
title: 'Examine stressor sensitivities'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}
# source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

library(MyFunctions)

my_lib(c("cowplot","tidyverse","wesanderson","here"))

source(here::here('common_fxns.R'))

select <- dplyr::select

```


# Summary

Examine the results of the stressor sensitivity scripts from O'Hara et al 2021.

# Methods

## Species impacted by each stressor

Plotting the number of species impacted by each stressor and country.  This plot includes species that:

* have an IUCN range map
* are in a comprehensively assessed taxon (and birds are seabirds)
* are threatened or near threatened (i.e. not LC or EX)
* are sensitive to at least one stressor in our study
* are present in the EEZs of Canada, Mexico and the USA (inlcuding Puerto Rico and Hawaii)


## Extract data

Because the original study is global, we had to first extract the data for only the North American countries we were interested in. For that we  combined a series of data available in the repository. The sensitvity data has an `iucn_id` category that can be match to the `range` data tha has an additional column for `eez`. The file `rgn_names_fixed.csv` has that information, note that the column `rgn_id` = `eez` in the `range` data. We selected the regions for 116 - Puerto Rico and Virgin Islands of the United States, 135 - Mexico, 163 - USA, 218 - Canada and further lumped regions 116 and 163 together. The analysis included only the species found in these regions.


```{r fig1a, message=F,warning=F}

# Get sensitivity data
sens_all_file <- here('_output', sprintf('spp_sensitivity_%s.csv', api_version))

sens_all_df <- read_csv(sens_all_file, col_types = cols('iucn_sid' = 'i')) %>%
  left_join(read_csv(here('_raw/stressor_names.csv')), by = 'stressor')

#### SELECT ONLY SPECIES FOUND IN NORTH AMERICAN EEZs

# For that we need to combine a series of data disperse in the repo
# range_from_rasts, gives us the range of each species per EEZ
range <- read.csv(here("_raw/range_from_rasts.csv"))

# Now we need to figure out what EEZ numbers we are interested in. Which means we need to find the data that gives us 
# EEZ id and name. Turns out that the file rgn_names_fixed.csv has that information, note that the column rgn_id in such data = eez in the range data

rgn_names <- read.csv(here("_spatial/rgn_names/rgn_names_fixed.csv")) %>% 
  select(rgn_id, rgn_label) %>%
  distinct() 

# Lets now filter out the EEZs we want
# rgn_names %>% arrange(rgn_label) %>% View()
# 116 - Puerto Rico and Virgin Islands of the United States
# 135 - Mexico
# 163 - USA
# 218 - Canada

# Select only the species from North America
na_spp_range <- range %>% 
  filter(eez %in% c(116,135,163,218)) %>% 
  rename('rgn_id' = 'eez') %>% # because the data have different column names
  left_join(rgn_names,
            by = "rgn_id") %>% 
  mutate(rgn_label = ifelse(rgn_label == "Puerto Rico and Virgin Islands of the United States","United States of America",rgn_label)) %>% 
  mutate(rgn_label = ifelse(rgn_label == "United States of America","USA",rgn_label)) %>% 
  select(iucn_sid,rgn_label) %>% 
  distinct()

# Get the sens data for those selected species
sens_na_df <- na_spp_range %>% 
  left_join(sens_all_df) 


```

## Plot panel A

This section is the same as O'Hara *et al* (2021) with the only difference that we are focusing on the countries mentioned above and that the data (plots) are presented by country and not general

```{r}

# Change sens_all_df for sens_na_df below
spp_incl <- get_incl_spp() %>%
  filter(!is.na(stressor)) %>% 
  filter(iucn_sid %in% sens_na_df$iucn_sid) # filter only species in the region

sens_df <- sens_na_df %>%
  filter(sens) %>%
  select(-code, -sens) %>%
  distinct() %>%
  filter(iucn_sid %in% spp_incl$iucn_sid) %>%
  mutate(category = tools::toTitleCase(category))

cat_sum_df <- sens_df %>%
  select(iucn_sid, rgn_label,category) %>% # added region
  group_by(category,rgn_label) %>% # added region
  summarize(n_spp = n_distinct(iucn_sid)) %>%
  arrange(desc(n_spp)) %>%
  mutate(str_desc = category)
  
plot1_df <- sens_df %>%
  group_by(str_desc, category,rgn_label) %>% # add region
  summarize(n_spp = n()) %>%
  ungroup() %>%
  bind_rows(cat_sum_df) %>%
  filter(str_desc != 'Ocean') %>%
  mutate(str_desc = ifelse(!str_detect(str_desc, '^Art'), 
                           str_replace(str_desc, ' fishing$', ''), str_desc)) %>%
  mutate(str_desc = str_replace(str_desc, 'destructive ', 'destr. ')) %>%
  mutate(str_desc = ifelse(str_desc == category, paste0('(Total ', str_desc, ')'), str_desc)) %>%
  mutate(str_desc = ifelse(str_desc == 'Shipping', 'Shipping (Total Ocean-Based)', str_desc)) %>%
  # mutate(category = factor(category, levels = cat_sum_df$category)) %>%
  arrange(desc(category), n_spp) %>%
  mutate(stressor = fct_inorder(str_desc))

bar_pal1 <- c(viridisLite::viridis(n = 4, option = 'D'), 'grey90')

n_spp_str <- ggplot(plot1_df, aes(x = stressor, y = n_spp, fill = category)) +
  geom_col() +
  geom_hline(yintercept = 0, color = 'grey30', size = .25) +
  geom_rect(xmin = 1, xmax = 8, ymin = 600, ymax = 200, 
            fill = 'white', color = 'grey90', size = .1) + ### suppress gridlines behind legend
  # scale_fill_viridis_d() +
  scale_fill_manual(values = bar_pal1) +
  labs(y = 'Sensitive species at-risk (count)',
       fill = 'Stressor category',
       x = "Stressor") +
  scale_y_continuous(expand = c(0.02, 0.02), limits = c(0, 150), breaks = seq(0, 150, 25)) +
  coord_flip() +
  # guides(fill = guide_legend(title.position = "top", 
  #                            # hjust = 1 # centres the title horizontally
  #                             title.hjust = 1,
  #                             label.position = "left")) +
  my_ggtheme_p(ax_tx_s = 8,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 8,facet_tx_s = 10,hjust = 0.5, leg_pos = "right") +
  facet_wrap(~rgn_label)

n_spp_str
```

## Plot panbel B

*Number of stressor sensitivities per species. This does not indicate spatial co-occurrence of stressors, just whether a species is sensitive to one, two, or more stressors.*

Here we maintain the analysis that the original authors did with the only difference that we do not filter out taxons, instead, we show all of them.


```{r fig1b, message=F,warning=F}

str_count_df <- spp_incl %>%
  group_by(iucn_sid, desc) %>%
  summarize(n_str = n_distinct(stressor),
            n_cat = n_distinct(category),
            strs = paste(unique(stressor), collapse = ', ')) %>% 
  ungroup()

# Finalized dataframe for figure
plot2_df <- str_count_df %>%
  gather(key = type, value = ct, n_str, n_cat) %>%
  arrange(ct) %>%
  mutate(ct = as.character(ct),
         ct = ifelse(as.integer(ct) > 5, '> 5', ct),
         ct = fct_inorder(ct),
         type = ifelse(type == 'n_str', 'Stressors (number out of 14)', 'Categories (number out of 4)'),
         desc = str_to_sentence(desc)
         ) 

# Set color
bar_pal2 <- c(wes_palette("Darjeeling1"),wes_palette("Darjeeling2"))

n_str_spp <-
  ggplot(plot2_df, aes(x = ct)) +
  geom_bar(position = 'stack', aes(fill = desc)) +
  geom_hline(yintercept = 0, color = 'grey30', size = .25) +
  theme(strip.placement = 'outside') +
  my_ggtheme_p(ax_tx_s = 8,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 8,facet_tx_s = 10,hjust = 0.5, leg_pos = "right") +
  scale_fill_manual(values = bar_pal2) +
  scale_y_continuous(breaks = seq(0,120,30),limits = c(0,120)) +
  labs(y = 'Species (count)',
       fill = 'Taxon',
       x = "") +
  facet_grid(~ type, scales = 'free_x', space = 'free_x', switch = 'x')

n_str_spp
```


## Combine both plots

``` {r combine, fig.height = 14, fig.width = 12}

fig1 <- ggdraw() +
  draw_plot(n_spp_str, x = 0, y = .40, height = .60, width = 1) +
  draw_plot(n_str_spp, x = 0, y = 0, height = .40, width = 1) +
  draw_label('A', x = 0.002, y = .99, hjust = 0, vjust = 1, 
             size = 10) +
  draw_label('B', x = 0.002, y = .42, hjust = 0, vjust = 1, 
             size = 10)

fname <- here('ms_figs/ncba_stressors_fig.png')

ggsave(plot = fig1, filename = fname, 
       width = 20, height = 15, units = 'cm', dpi = 300)

fig1
```

