---
title: "Untitled"
author: "Juliano Palacios-Abrantes"
date: "`r Sys.Date()`"
output: html_document
---



```{r setup}


library(MyFunctions)

my_lib(c("tidyverse","Rmisc","grid","gridExtra", # Fig 1
         "purrr","igraph","readr","raster", # Fig 4
         "sf","ebvcube","xlsx", # Regional analysis script
         "lubridate","BiocManager","HDF5Array"
) 
)


```



# Instructions

Code modified from thta provided by Pereira et al. (2024). Global trends and scenarios for terrestrial biodiversity and ecosystem services from 1900-2050. Science https://doi.org/10.1126/science.adn3441. 

## Re-do Global analysis

In this part we are going to re-do the global analysis from Pereira *et al.* (2024) but only for the North America region that we are interested in. Original code in script `BES-SIM_statistics_global.R`

### Figure 2

```{r}

root <- my_path("D","hpereira/ncdf_global_data")

```


```{r}

#download data
globio_path <- ebv_download('10.25829/r7bt92', root)
predicts_path <- ebv_download('10.25829/vt7qk9', root)
iiasa_path <- ebv_download('10.25829/haq7d4', root)
csar_path <- ebv_download('10.25829/5zmy41', root)
aim_path <- ebv_download('10.25829/5wn357', root)
insight_path <- ebv_download('10.25829/h2evr2', root)

```

```{r}
# ebv_datacubepaths(predicts_path)
predicts_hist <- ebv_read(filepath = predicts_path,
                          datacubepath = 'scenario_1/metric_3/ebv_cube',
                          timestep = 2,
                          entity = 1, type='r')
predicts_2050_ssp1_lu <- ebv_read(filepath = predicts_path,
                                  datacubepath = 'scenario_1/metric_3/ebv_cube',
                                  timestep = 3,
                                  entity = 1, type='r')
predicts_2050_ssp2_lu <- ebv_read(filepath = predicts_path,
                                  datacubepath = 'scenario_2/metric_3/ebv_cube',
                                  timestep = 3,
                                  entity = 1, type='r')

predicts_2050_ssp3_lu <- ebv_read(filepath = predicts_path,
                                  datacubepath = 'scenario_3/metric_3/ebv_cube',
                                  timestep = 3,
                                  entity = 1, type='r')


# ebv_datacubepaths(iiasa_path)
iiasa_hist <- ebv_read(filepath = iiasa_path,
                       datacubepath = 'scenario_1/metric_3/ebv_cube',
                       timestep = 2,
                       entity = 1, type='r')
iiasa_2050_ssp1_lu <- ebv_read(filepath = iiasa_path,
                               datacubepath = 'scenario_1/metric_3/ebv_cube',
                               timestep = 3,
                               entity = 1, type='r')
iiasa_2050_ssp2_lu <- ebv_read(filepath = iiasa_path,
                               datacubepath = 'scenario_2/metric_3/ebv_cube',
                               timestep = 3,
                               entity = 1, type='r')
iiasa_2050_ssp3_lu <- ebv_read(filepath = iiasa_path,
                               datacubepath = 'scenario_3/metric_3/ebv_cube',
                               timestep = 3,
                               entity = 1, type='r')

# ebv_datacubepaths(csar_path)
csar_hist <- ebv_read(filepath = csar_path,
                      datacubepath = 'scenario_1/metric_3/ebv_cube',
                      timestep = 2,
                      entity = 1, type='r')
csar_2050_ssp1_lu <- ebv_read(filepath = csar_path,
                              datacubepath = 'scenario_1/metric_3/ebv_cube',
                              timestep = 3,
                              entity = 1, type='r')
csar_2050_ssp2_lu <- ebv_read(filepath = csar_path,
                              datacubepath = 'scenario_2/metric_3/ebv_cube',
                              timestep = 3,
                              entity = 1, type='r')
csar_2050_ssp3_lu <- ebv_read(filepath = csar_path,
                              datacubepath = 'scenario_3/metric_3/ebv_cube',
                              timestep = 3,
                              entity = 1, type='r')
# ebv_datacubepaths(aim_path)
aim_hist <- ebv_read(filepath = aim_path,
                     datacubepath = 'scenario_1/metric_3/ebv_cube',
                     timestep = 2,
                     entity = 2, type='r')
aim_2050_ssp1_lu <- ebv_read(filepath = aim_path,
                             datacubepath = 'scenario_1/metric_3/ebv_cube',
                             timestep = 3,
                             entity = 2, type='r')
aim_2050_ssp2_lu <- ebv_read(filepath = aim_path,
                             datacubepath = 'scenario_2/metric_3/ebv_cube',
                             timestep = 3,
                             entity = 2, type='r')
aim_2050_ssp3_lu <- ebv_read(filepath = aim_path,
                             datacubepath = 'scenario_3/metric_3/ebv_cube',
                             timestep = 3,
                             entity = 2, type='r')
aim_2050_ssp1_lucc <- ebv_read(filepath = aim_path,
                               datacubepath = 'scenario_4/metric_3/ebv_cube',
                               timestep = 3,
                               entity = 2, type='r')
aim_2050_ssp2_lucc <- ebv_read(filepath = aim_path,
                               datacubepath = 'scenario_5/metric_3/ebv_cube',
                               timestep = 3,
                               entity = 2, type='r')
aim_2050_ssp3_lucc <- ebv_read(filepath = aim_path,
                               datacubepath = 'scenario_6/metric_3/ebv_cube',
                               timestep = 3,
                               entity = 2, type='r')

# ebv_datacubepaths(insight_path)
insight_hist <- ebv_read(filepath = insight_path,
                         datacubepath = 'scenario_1/metric_3/ebv_cube',
                         timestep = 2,
                         entity = 1, type='r')
insight_2050_ssp1_lu <- ebv_read(filepath = insight_path,
                                 datacubepath = 'scenario_1/metric_3/ebv_cube',
                                 timestep = 3,
                                 entity = 1, type='r')
insight_2050_ssp2_lu <- ebv_read(filepath = insight_path,
                                 datacubepath = 'scenario_2/metric_3/ebv_cube',
                                 timestep = 3,
                                 entity = 1, type='r')
insight_2050_ssp3_lu <- ebv_read(filepath = insight_path,
                                 datacubepath = 'scenario_3/metric_3/ebv_cube',
                                 timestep = 3,
                                 entity = 1, type='r')
insight_2050_ssp1_lucc <- ebv_read(filepath = insight_path,
                                   datacubepath = 'scenario_4/metric_3/ebv_cube',
                                   timestep = 3,
                                   entity = 1, type='r')
insight_2050_ssp2_lucc <- ebv_read(filepath = insight_path,
                                   datacubepath = 'scenario_5/metric_3/ebv_cube',
                                   timestep = 3,
                                   entity = 1, type='r')
insight_2050_ssp3_lucc <- ebv_read(filepath = insight_path,
                                   datacubepath = 'scenario_6/metric_3/ebv_cube',
                                   timestep = 3,
                                   entity = 1, type='r')

#extend aim results
aim_hist <- terra::extend(aim_hist,predicts_hist)
aim_2050_ssp1_lu <- terra::extend(aim_2050_ssp1_lu,predicts_hist)
aim_2050_ssp2_lu <- terra::extend(aim_2050_ssp2_lu,predicts_hist)
aim_2050_ssp3_lu <- terra::extend(aim_2050_ssp3_lu,predicts_hist)
aim_2050_ssp1_lucc <- terra::extend(aim_2050_ssp1_lucc,predicts_hist)
aim_2050_ssp2_lucc <- terra::extend(aim_2050_ssp2_lucc,predicts_hist)
aim_2050_ssp3_lucc <- terra::extend(aim_2050_ssp3_lucc,predicts_hist)

```


###Calculations 

```{r}

#historical
#stack the rasters
hist_stack <- c(predicts_hist, iiasa_hist, insight_hist, aim_hist, csar_hist) #
#calculate mean
hist_mean <- app(hist_stack, mean, na.rm=T)

#ssp1 lu
#stack the rasters
ssp1_lu_stack <- c(predicts_2050_ssp1_lu, aim_2050_ssp1_lu, 
                   iiasa_2050_ssp1_lu, csar_2050_ssp1_lu,
                   insight_2050_ssp1_lu)
#calculate mean
ssp1_lu_mean <- app(ssp1_lu_stack, mean, na.rm=T)


#ssp2 lu
#stack the rasters
ssp2_lu_stack <- c(predicts_2050_ssp2_lu, aim_2050_ssp2_lu, 
                   iiasa_2050_ssp2_lu, csar_2050_ssp2_lu,
                   insight_2050_ssp2_lu)
#calculate mean
ssp2_lu_mean <- app(ssp2_lu_stack, mean, na.rm=T)

#ssp3 lu
#stack the rasters
ssp3_lu_stack <- c(predicts_2050_ssp3_lu, aim_2050_ssp3_lu, 
                   iiasa_2050_ssp3_lu, csar_2050_ssp3_lu,
                   insight_2050_ssp3_lu)
#calculate mean
ssp3_lu_mean <- app(ssp3_lu_stack, mean, na.rm=T)


#ssp1 lucc
#stack the rasters
ssp1_lucc_stack <- c(aim_2050_ssp1_lucc, insight_2050_ssp1_lucc)
#calculate mean
ssp1_lucc_mean <- app(ssp1_lucc_stack, mean, na.rm=T)


#ssp2 lucc
#stack the rasters
ssp2_lucc_stack <- c(aim_2050_ssp2_lucc, insight_2050_ssp2_lucc)
#calculate mean
ssp2_lucc_mean <- app(ssp2_lucc_stack, mean, na.rm=T)

#ssp3 lucc
#stack the rasters
ssp3_lucc_stack <- c(aim_2050_ssp3_lucc, insight_2050_ssp3_lucc)
#calculate mean
ssp3_lucc_mean <- app(ssp3_lucc_stack, mean, na.rm=T)
```

### Plot me

```{r}

#calculate mean per decade
hist_mean_yrl <- (((1+(hist_mean/100))^(1/11.5))-1)*100
ssp1_lu_mean_yrl <-(((1+(ssp1_lu_mean/100))^(1/3.5))-1)*100
ssp2_lu_mean_yrl <- (((1+(ssp2_lu_mean/100))^(1/3.5))-1)*100
ssp3_lu_mean_yrl <- (((1+(ssp3_lu_mean/100))^(1/3.5))-1)*100
ssp1_lucc_mean_yrl <-(((1+(ssp1_lucc_mean/100))^(1/3.5))-1)*100
ssp2_lucc_mean_yrl <-(((1+(ssp2_lucc_mean/100))^(1/3.5))-1)*100
ssp3_lucc_mean_yrl <-(((1+(ssp3_lucc_mean/100))^(1/3.5))-1)*100

# Re scale crop and transform to sf for plotting
re_scale_lu <- function(x){
  output <- x %>% 
    mutate(mean = ifelse(mean < -0.02,-1.02,
                         ifelse(mean > 1.08,1.08, mean))) %>% 
    filter(y >= 10,
           x >= -180 & x<= -50) %>%
    st_as_sf(coords = c("x", "y"), crs = 4326) %>% 
    st_intersection(world_land) %>% 
    st_shift_longitude()
}

re_scale_luc <- function(x){
  output <- x %>% 
    mutate(mean = ifelse(mean < -7.38,-8,
                         ifelse(mean > 0.61,0.6, mean))) %>% 
    filter(y >= 10,
           x >= -180 & x<= -50) %>%
    st_as_sf(coords = c("x", "y"), crs = 4326) %>% 
    st_intersection(world_land) %>% 
    st_shift_longitude()
}

# Re scale figures
hist_mean_yrl_sf <- as.data.frame(terra::as.data.frame(hist_mean_yrl, xy = TRUE, na.rm = TRUE)) %>% 
  re_scale_lu()
ssp1_lu_mean_yrl_sf <- as.data.frame(terra::as.data.frame(ssp1_lu_mean_yrl, xy = TRUE, na.rm = TRUE)) %>% 
  re_scale_lu()
ssp2_lu_mean_yrl_sf <- as.data.frame(terra::as.data.frame(ssp2_lu_mean_yrl, xy = TRUE, na.rm = TRUE)) %>% 
  re_scale_lu()
ssp3_lu_mean_yrl_sf <- as.data.frame(terra::as.data.frame(ssp3_lu_mean_yrl, xy = TRUE, na.rm = TRUE)) %>% 
  re_scale_lu()
ssp1_lucc_mean_yrl_sf <- as.data.frame(terra::as.data.frame(ssp1_lucc_mean, xy = TRUE, na.rm = TRUE)) %>% 
  re_scale_luc()
ssp2_lucc_mean_yrl_sf <- as.data.frame(terra::as.data.frame(ssp2_lucc_mean, xy = TRUE, na.rm = TRUE)) %>% 
  re_scale_luc()
ssp3_lucc_mean_yrl_sf <- as.data.frame(terra::as.data.frame(ssp3_lucc_mean, xy = TRUE, na.rm = TRUE)) %>% 
  re_scale_luc()




ggplot_me <- function(x,leg = F){
  
  plot_out <- ggplot(x) +
    geom_sf(data = x, aes(color = mean), size = 0.9) +
    geom_sf(data = world_land %>% st_shift_longitude(), aes(), fill ="transparent") +
    scale_color_viridis_b("% spp. decade (ABCD)\n% spp. decade (EFG)",
                              labels = c("< -1.02\n< -8", "-0.75\n-6", "-0.50\n-4","-0.25\n-2","> 1.08\n> 0.6")  # Custom labels
                          
    ) +
    my_ggtheme_p(ax_tx_s = 8,ax_tl_s = 10,leg_tl_s = 10,leg_tx_s = 8,facet_tx_s = 10,leg_pos = "") +
    theme(plot.margin = unit(c(.05, 0, .05, 0), units = 'cm'),
          legend.background = element_blank(),
          legend.key.width = unit(.25, 'cm'),
          legend.title = element_text(vjust = 0.1),
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          # legend.title = element_blank(),
          legend.box.margin=margin(20,20,20,20)
    ) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    my_ggtheme_m(leg_width = 3,leg_pos = "")
  
  if(leg == T){
    plot_out <- plot_out +
      theme(legend.position = ""
      )+
      my_ggtheme_m(leg_width = 3) 
    
    
  }
  
  
  return(plot_out)
}


# Plot each one
hist_mean_yrl_map <- ggplot_me(hist_mean_yrl_sf) + ggtitle("A - Historical") 
ssp1_lu_mean_yrl_map <-  ggplot_me(ssp1_lu_mean_yrl_sf) + ggtitle("B - Global sustainability (LU)") 
ssp2_lu_mean_yrl_map <- ggplot_me(ssp2_lu_mean_yrl_sf) + ggtitle("C - Regional rivalry (LU)")
ssp3_lu_mean_yrl_map <-  ggplot_me(ssp3_lu_mean_yrl_sf) + ggtitle("D - Fossil−fueled development (LU)")
ssp1_lucc_mean_yrl_map <- ggplot_me(ssp1_lucc_mean_yrl_sf) + ggtitle("E - Global sustainability (LUCC)")
ssp2_lucc_mean_yrl_map <- ggplot_me(ssp2_lucc_mean_yrl_sf) + ggtitle("F - Regional rivalry (LUCC)")
ssp3_lucc_mean_yrl_map <- ggplot_me(ssp3_lucc_mean_yrl_sf) + ggtitle("G - Fossil−fueled development (LUCC)")

# Dummy plot
x <- ggplot() + geom_line() + my_ggtheme_m()

combined_plot <- ggarrange(x,
                           hist_mean_yrl_map,
                           x,
                           ssp1_lu_mean_yrl_map,
                           ssp2_lu_mean_yrl_map,
                           ssp3_lu_mean_yrl_map,
                           ssp1_lucc_mean_yrl_map,
                           ssp2_lucc_mean_yrl_map,
                           ssp3_lucc_mean_yrl_map,
                           common.legend = T,
                           legend = "bottom"
)

ggsave("ncba_land_delta_spp_richness.jpg", plot = combined_plot, width = 10, height = 10)

```
