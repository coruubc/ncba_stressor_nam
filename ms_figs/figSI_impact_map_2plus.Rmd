---
title: 'Fig SI: impacts on species by multiple stressors (2+)'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(sf)
library(cowplot)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

reload <- FALSE
```


# Summary

Create figure for manuscript SI.

# Methods

## Fig. 1A

Load rasters of impacted spp for 2013; make a cool map.

``` {r figure 1a}

imp_count  <- raster(here('_output/rasters/impact_maps/impact_all_2013_2plus.tif'))

xfm <- function(x) log10(x) ### how are we transforming count?

imp_ct_df <- rasterToPoints(imp_count) %>%
  as.data.frame() %>%
  setNames(c('x', 'y', 'imp_ct')) %>%
  mutate(xfm_imp_ct = xfm(imp_ct))

max_ct <- max(imp_ct_df$imp_ct, na.rm = TRUE)
ct_labels <- c(1, 10, 100, max_ct)
ct_breaks <- xfm(ct_labels)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(crs(imp_count))

fig_sia_impact_ct_map <- ggplot() +
  ggtheme_map(base_size = 7) +
  geom_raster(data = imp_ct_df, aes(x, y, fill = xfm_imp_ct)) +
  geom_sf(data = land_sf, fill = 'grey96', color = 'grey40', size = .10) +
  scale_fill_viridis_c(breaks = ct_breaks,
                       labels = ct_labels,
                       na.value = 'grey80') +
  theme(plot.margin = unit(c(.05, 0, .05, 0), units = 'cm'),
        legend.background = element_blank(),
        legend.key.width = unit(.25, 'cm'),
        legend.title = element_blank()) +
  coord_sf(datum = NA) + ### ditch graticules
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))

# fig_sia_impact_ct_map

```

## Fig. 1B

Load rasters of impacted spp and species count for 2013; generate impacted spp by pct; make a cool map.

``` {r figure 1b}
imp_count  <- raster(here('_output/rasters/impact_maps/impact_all_2013_2plus.tif'))
nspp <- raster(here('_output/rasters/n_spp_map.tif')) 

imp_pct <- imp_count / nspp

imp_pct_df <- rasterToPoints(imp_pct) %>%
  as.data.frame() %>%
  rename(imp_pct = layer)

land_sf <- read_sf(here('_spatial/ne_10m_land/ne_10m_land_no_casp.shp')) %>%
  st_transform(crs(imp_pct))

fig_sib_impact_pct_map <- ggplot() +
  ggtheme_map(base_size = 7) +
  geom_raster(data = imp_pct_df, aes(x, y, fill = imp_pct)) +
  geom_sf(data = land_sf, fill = 'grey96', color = 'grey40', size = .10) +
  scale_fill_viridis_c(breaks = seq(0, 1, .25), 
                       labels = paste0(seq(0, 100, 25), '%'),
                       na.value = 'grey80') +
  theme(plot.margin = unit(c(.05, 0, .05, 0), units = 'cm'),
        legend.background = element_blank(),
        legend.key.width = unit(.25, 'cm'),
        legend.title = element_blank()) +
  coord_sf(datum = NA) + ### ditch graticules
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))

# print(fig_sib_impact_pct_map)

```

## Combine into one figure

```{r}
figSI_file <- here('ms_figs/si_impact_2plus.png')

if(!file.exists(figSI_file)) {
  fig_sia_panel  <- get_panel(fig_sia_impact_ct_map)
  fig_sib_panel  <- get_panel(fig_sib_impact_pct_map)
  fig_sia_legend <- get_legend(fig_sia_impact_ct_map)
  fig_sib_legend <- get_legend(fig_sib_impact_pct_map)

  fig_si <- ggdraw() +
    draw_plot(fig_sia_panel,  x = .01, y = 0.51, width = .88, height = .49) +
    draw_plot(fig_sib_panel,  x = .01, y = 0.01, width = .88, height = .49) +
    draw_plot(fig_sia_legend, x = .89, y = 0.51, width = .1, height = .49) +
    draw_plot(fig_sib_legend, x = .895, y = 0.01, width = .1, height = .49) +
    draw_label('A', x = .05, y = .95, vjust = 1, size = 9, color = 'grey20', fontface = 'bold') +
    draw_label('B', x = .05, y = .45, vjust = 1, size = 9, color = 'grey20', fontface = 'bold') +
    draw_label('Species impacted\nby 2+ stressors\n(count)', 
               x = .93, y = .98, hjust = 1, vjust = 1, 
               size = 7, color = 'grey20', fontface = 'bold') +
    draw_label('Species impacted\nby 2+ stressors\n(percent)', 
               x = .93, y = .48, hjust = 1, vjust = 1, 
               size = 7, color = 'grey20', fontface = 'bold') 
    
  ggsave(plot = fig_si, filename = figSI_file,
         height = 10, width = 12, units = 'cm', dpi = 300)
}

knitr::include_graphics(figSI_file)
# unlink(fig_si_file)
```

