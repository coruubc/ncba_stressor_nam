---
title: 'Calculate species impact expansion'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(sf)
library(cowplot)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

```


# Summary

Monte Carlo approach to determining distribution of impact expansion across species 

## Methods summary

Read in all the impact summaries.  Attach taxonomic information and range information.

For cumulative stressors, calculate impact expansion slope and intercept including standard errors.  Run Monte Carlo simulations drawing a slope and intercept of expansion for each species then calculating 2030 projection.  Do this a bunch o' times.

# Methods

## Get data on range expansion trends

Trends are already calculated for the original Figure 2 script.  Read those in. (Note: intercepts are dropped; for now use the 2013 value as the intercept.) Drop non-significant trend calculations?

Use trends to predict species impacted range in 2030 using Monte Carlo simulations. 

```{r}
imp_range_file <- file.path(here('int/impacted_ranges.csv'))
spp_expansion_trend_file <- here('int/spp_expansion_trends.csv')

trend_df <- read_csv(spp_expansion_trend_file) %>%
  filter(stressor == 'cum_all') %>%
  # filter(p.value < .05) %>%
  select(-stressor)

impact_df <- read_csv(imp_range_file) %>%
  filter(year == 2013) %>%
  filter(stressor == 'cum_all') %>%
  filter(!is.na(pct_impact)) %>%
  select(pct_impact, iucn_sid)

trend_all_df <- impact_df %>%
  left_join(trend_df, by = 'iucn_sid') %>%
  mutate(term = str_replace_all(tolower(term), '[^a-z]', ''),
         estimate = ifelse(is.na(estimate), 0, estimate),
         std.error = ifelse(is.na(std.error), 0, std.error))

sims <- 1000
results_list <- vector('list', length = sims)
for(sim in 1:sims) {
  sim_df <- trend_all_df %>%
    rowwise() %>%
    mutate(draw = rnorm(n = 1, mean = estimate, sd = std.error)) %>%
    ungroup() %>%
    select(iucn_sid, draw, term) %>%
    spread(term, draw) %>%
    rowwise() %>%
    mutate(intercept = ifelse(is.na(intercept), 0, intercept),
           year      = ifelse(is.na(year), 0, year),
           pct_imp_2030 = intercept + (2030 - 2003) * year,
           pct_imp_2030 = min(1, max(0, pct_imp_2030))) %>%
    ungroup()
  
  results_list[[sim]] <- sim_df %>%
    summarize(mu = mean(pct_imp_2030),
              sig = sd(pct_imp_2030))
}
  
results_df <- bind_rows(results_list)
hist(results_df$mu)
hist(results_df$sig)
```

Well that's pretty uninteresting.  Looks like even a Monte Carlo simulation drawing slopes and intercepts from the estimated distribution of trends for each species, we get a very tight distribution of the mean and standard deviation of the results.  Note the mean here is around .555 instead of calculated as around .59, probably because using 2003 as the intercept instead of starting with 2013 values.  


