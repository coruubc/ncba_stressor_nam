---
title: "Untitled"
author: "Casey O'Hara"
date: "6/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

From Leslie: "we don't dive deeper into which countries share 2-country species, especially when one of those EEZs is the ABNJ."

## generate fake data

Assign a bunch of species across a bunch of EEZs randomly.  Use a Poisson distribution so lots of spp in few EEZs, but few spp across many EEZs.  Minimum 1 EEZ per spp.

```{r}
spp_ids <- 1:1000
eez_ids <- LETTERS[1:25]

test_df <- data.frame(spp_id = spp_ids) %>%
  mutate(n_eez = 1 + rpois(length(spp_ids), lambda = 1)) %>%
  uncount(n_eez) %>%
  group_by(spp_id) %>%
  mutate(eez = sample(eez_ids, size = n(), replace = FALSE)) %>%
  ungroup() %>%
  ### to make sure all EEZs are represented, even if no spp present:
  complete(eez = eez_ids)

```

## Method 1: which EEZ pairs host the most spp in common

If focusing only on two-country spp (i.e. EEZ count is exactly 2), filter out the others; then group by unique EEZ pairs and see how many spp each EEZ pair includes.

```{r}
pairs_df <- test_df %>%
  group_by(spp_id) %>%
  filter(n_distinct(eez) == 2) %>%
  arrange(eez) %>%
  summarize(eez1 = first(eez), eez2 = last(eez))

result_df <- pairs_df %>%
  group_by(eez1, eez2) %>%
  summarize(n_spp = n_distinct(spp_id))
```

Results - how many EEZ pairs contain `n` species: 
`r table(result_df$n_spp)`

## Method 2: pairwise counts

This will show how many species two EEZs have in common (even if a species spans more than two EEZs).  The diagonal is how many species an EEZ has in common with itself, i.e. how many species are found in that EEZ.

```{r}
library(widyr)

result2_df <- pairwise_count(test_df, eez, spp_id, sort = TRUE) %>%
  rename(eez1 = item1, eez2 = item2)

### diag includes the diagonal (i.e. in this case, how many spp in each cell)
result3_df <- pairwise_count(test_df, eez, spp_id, sort = TRUE, diag = TRUE) %>%
  rename(eez1 = item1, eez2 = item2)

result3_mtx <- result3_df %>%
  spread(key = eez2, value = n) %>%
  select(-eez1) %>%
  as.matrix()

### rename rows and columns to match EEZs
rownames(result3_mtx) <- eez_ids
colnames(result3_mtx) <- eez_ids

### set NAs to zero
result3_mtx[is.na(result3_mtx)] <- 0

result3_mtx
```

