---
title: 'Examine stressor sensitivities'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here::here('common_fxns.R'))
```


# Summary

Examine the results of the stressor sensitivity scripts.

# Methods

## Species impacted by each stressor

Plotting the number of species impacted by each stressor.  This plot includes species that:

* have an IUCN range map
* are in a comprehensively assessed taxon (and birds are seabirds)
* are threatened or near threatened (i.e. not LC or EX)
* are sensitive to at least one stressor in our study

```{r}
sens_all_file <- here('_output', sprintf('spp_sensitivity_%s.csv', api_version))

sens_all_df <- read_csv(sens_all_file, col_types = cols('iucn_sid' = 'i')) %>%
  left_join(read_csv(here('_raw/stressor_names.csv')), by = 'stressor')

spp_incl <- get_incl_spp() %>%
  filter(!is.na(stressor))

plot_df <- sens_all_df %>%
  filter(sens) %>%
  select(-code, -sens) %>%
  distinct() %>%
  filter(iucn_sid %in% spp_incl$iucn_sid) %>%
  group_by(str_desc, category) %>%
  summarize(n_spp = n()) %>%
  ungroup() %>%
  arrange(n_spp) %>%
  mutate(category = factor(category, levels = c("climate", "fishing", "land-based", "ocean")),
         stressor = fct_inorder(str_desc))

n_spp_str <- ggplot(plot_df, aes(x = stressor, y = n_spp, fill = category)) +
  ggtheme_plot(base_size = 7) +
  geom_col() +
  scale_fill_viridis_d() +
  coord_flip() +
  labs(x = 'Stressor',
       y = 'Number of impacted species')

```

## Number of stressor sensitivities per species

This does not indicate spatial co-occurrence of stressors, just whether a species is sensitive to one, two, or more stressors.

```{r}

spp_incl <- get_incl_spp() %>%
  filter(!is.na(stressor))

str_count_df <- spp_incl %>%
  group_by(iucn_sid) %>%
  summarize(n_str = n_distinct(stressor),
            n_cat = n_distinct(category),
            strs = paste(unique(stressor), collapse = ', ')) %>%
  ungroup()

plot_df <- str_count_df %>%
  rename(stressors = n_str, `stressor categories` = n_cat) %>%
  gather(key = type, value = ct, stressors, `stressor categories`) %>%
  arrange(ct) %>%
  mutate(ct = as.character(ct),
         ct = ifelse(as.integer(ct) > 5, '> 5', ct),
         ct = fct_inorder(ct))

n_str_spp <- ggplot(plot_df, aes(x = ct)) +
  ggtheme_plot(base_size = 7) +
  geom_bar(position = 'dodge', fill = 'grey20') +
  theme(axis.title.x = element_blank()) +
  labs(y = 'Number of species') +
  facet_wrap(~ type, nrow = 1, scales = 'free_x')

z <- cowplot::plot_grid(n_spp_str, n_str_spp, 
                        nrow = 2,
                        labels = c('A', 'B'), label_size = 9, label_colour = 'grey20')

ggsave(plot = z, filename = here('ms_figs/si_n_sensitivity.png'), 
       width = 12, height = 8, units = 'cm', dpi = 300)

knitr::include_graphics(here('ms_figs/si_n_sensitivity.png'))
```

## Try a pairwise table to examine # of spp with pairwise combos of stressors

```{r}
library(widyr)

spp_str_incidence <- get_incl_spp() %>%
  filter(!is.na(stressor)) %>%
  select(iucn_sid, stressor) %>%
  distinct()

result_df <- pairwise_count(spp_str_incidence,
                             item = stressor, feature = iucn_sid, 
                             sort = TRUE, diag = TRUE) %>%
  rename(str1 = item1, str2 = item2)

result_mtx <- result_df %>%
  spread(key = str2, value = n) %>%
  select(-str1) %>%
  as.matrix()

### rename rows and columns to match EEZs
rownames(result_mtx) <- colnames(result_mtx)

### set NAs to zero
result_mtx[is.na(result_mtx)] <- 0

# result_mtx

mtxplot_df <- result_df %>%
  mutate(n = ifelse(str2 > str1, NA, n),
         str1 = fct_rev(str1))
ggplot(mtxplot_df, aes(x = str1, y = str2)) +
  ggtheme_plot() +
  geom_point(aes(size = n)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title = element_blank())
```
