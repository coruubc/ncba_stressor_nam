---
title: 'Examine co-occurrence of impacted taxonomic groups'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(widyr) ### for function: pairwise_count()

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

source(here('common_fxns.R'))

reload <- FALSE
```


# Summary

Examine co-occurrence of impacts on taxonomic groups for each stressor category.  For each group, identify cells with significant impacts (e.g. greater than 25% of spp in the group are impacted), convert to a presence/absence of significant impacts, and then create a pairwise plot to show which taxonomic groups co-occur (in pairs).

Do the same for intensification maps (don't worry about abatement?)

# Methods

For each stressor category:

* pull in impact rasters for all taxonomic groups for 2013.
* flatten to "significantly impacted" by taxon.
* combine into a dataframe; join with ocean area.
* calculate pairwise impacted area for each taxon pair.

## Helper functions

* Function `get_taxon_impacts()` to read in a taxon map and convert to a data.frame with impacted spp, total spp, and pct impacted.
* Function `flatten_impacts()` to get taxon impacts (using the function above) and return only those cell IDs that meet or exceed a given threshold.

```{r}
dir_tx_imp  <- file.path(dir_bd_anx, 'taxon_impact_rasts')
dir_tx_nspp <- here('_output/rasters/taxon_richness_maps')

get_taxon_impacts <- function(tx, str) {
  ### tx <- 'aves'; str <- 'all'
  imp_f  <- file.path(dir_tx_imp,  sprintf('taxon_impact_%s_2013_%s.tif', tx, str))
  nspp_f <- file.path(dir_tx_nspp, sprintf('taxon_nspp_%s.tif', tx))
  
  imp_r  <- raster(imp_f)
  nspp_r <- raster(nspp_f)
  imp_df <- data.frame(cell_id = 1:ncell(imp_r),
                       imp  = values(imp_r),
                       nspp = values(nspp_r)) %>%
    filter(!is.na(imp) & !is.na(nspp)) %>%
    mutate(taxon = tx)
}

flatten_impacts <- function(tx, str, thresh) {
  sig_imp_df <- get_taxon_impacts(tx, str) %>%
    filter(imp / nspp >= thresh) %>%
    select(cell_id, taxon)
}
```


```{r explore thresholds}

ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))
ocean_a_df <- data.frame(cell_id = 1:ncell(ocean_a_rast),
                         a_prop = values(ocean_a_rast)) %>%
  filter(!is.na(a_prop)) %>%
  mutate(a_km2 = a_prop * res(ocean_a_rast)[1]^2 / 1e6)

spp_sens <- get_incl_spp() %>%
  filter(!is.na(stressor))

taxa_gps <- spp_sens$taxon %>% unique() %>% sort()

str_cats <- c('fishing', 'climate', 'ocean', 'land-based', 'all')

for(str_cat in str_cats) {
  ### str_cat <- str_cats[1]

  # for(thresh in seq(.25, 1, .25)) {
    thresh <- .25

    tx_str_df <- parallel::mclapply(
      taxa_gps, FUN = function(tx) {
        df <- flatten_impacts(tx, str_cat, thresh = thresh)
      }, mc.cores = 9) %>%
      bind_rows() %>%
      dt_join(ocean_a_df, by = 'cell_id', type = 'left')
    
    result_df <- pairwise_count(tx_str_df,
                                item = taxon, feature = cell_id, wt = a_km2,
                                sort = TRUE, diag = TRUE) %>%
      rename(tx1 = item1, tx2 = item2)
  
    mtxplot_df <- result_df %>%
      mutate(n = ifelse(tx1 < tx2, NA, n),
             tx1 = fct_rev(tx1))
    
    pairwise_plot <- ggplot(mtxplot_df, aes(x = tx1, y = tx2)) +
      ggtheme_plot() +
      geom_point(aes(size = n)) +
      theme(axis.text.x = element_text(angle = 60, hjust = 1),
            axis.title = element_blank()) +
      labs(title = sprintf('Taxa impact co-occurrence: %s, thresh = %s', str_cat, thresh))
    
    print(pairwise_plot)
    
    # taxa_map_df <- tx_str_df %>%
    #   group_by(cell_id) %>%
    #   summarize(n_tx = n())
    # 
    # taxa_map <- map_to_rast(taxa_map_df, cell_val = 'n_tx')
    # plot(taxa_map,
    #      axes = F, col = c(hcl.colors(n = 9)),
    #      main = sprintf('# of taxa impacted: %s, thresh = %s', str_cat, thresh))
  # }
}


```

```{r pairwise plot for stressor categories}

library(ggforce) ### for geom_arc_bar()

ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))
ocean_a_df <- data.frame(cell_id = 1:ncell(ocean_a_rast),
                         a_prop = values(ocean_a_rast)) %>%
  filter(!is.na(a_prop)) %>%
  mutate(a_km2 = a_prop * res(ocean_a_rast)[1]^2 / 1e6)

spp_sens <- get_incl_spp() %>%
  filter(!is.na(stressor))

taxa_gps <- spp_sens$taxon %>% unique() %>% sort()

### first assemble df for full-ocean impacts using 25% threshold
results_df <- data.frame()
for(str_cat in str_cats) {
  ### str_cat <- 'climate'
  tx_str_df <- parallel::mclapply( # tx <- taxa_gps[1]
    taxa_gps, FUN = function(tx) {
      df <- flatten_impacts(tx, str_cat, thresh = .25)
    }, mc.cores = 9) %>%
    bind_rows() %>%
    dt_join(ocean_a_df, by = 'cell_id', type = 'left')
  
  tmp_df <- pairwise_count(tx_str_df,
                              item = taxon, feature = cell_id, wt = a_km2,
                              sort = TRUE, diag = TRUE) %>%
    rename(tx1 = item1, tx2 = item2, area_km2 = n) %>%
    mutate(str = str_cat)
  
  results_df <- bind_rows(results_df, tmp_df)
}

write_csv(results_df, here('_output/taxa_pairwise_results.csv'))

### Note: geom_arc_bar doesn't seem to like factors on axes
mtxplot_df <- results_df %>%
  filter(tx1 >= tx2) %>%
  mutate(tx1 = fct_rev(tx1),
         tx2 = factor(tx2)) %>%
  mutate(tx1_n = as.integer(tx1),
         tx2_n = as.integer(tx2),
         str = factor(str),
         # r = log(area_km2) / log(max(area_km2, na.rm = TRUE)) / 2.5,
         r = (area_km2 / max(area_km2, na.rm = TRUE))^(1/2) / 2.5 + .08,
         start = (as.integer(str) - 1) * pi/2,
         end   = (as.integer(str)) * pi/2)

fcol_mtxplot_df <- mtxplot_df %>%
  filter(str != 'all')
all_mtxplot_df <- mtxplot_df %>%
  filter(str == 'all')

pairwise_plot <- ggplot(fcol_mtxplot_df, aes(x0 = tx1_n, y0 = tx2_n, r = r)) +
  ggtheme_plot() +
  geom_abline(intercept = 10, slope = -1, color = 'darkred', alpha = .5) +
  geom_circle(data = all_mtxplot_df, size = .1, color = 'grey30', fill = 'white') +
  geom_arc_bar(aes(r0 = 0, start = start, end = end, fill = str),
               color = 'grey30', size = .1) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title = element_blank()) +
  scale_x_continuous(breaks = 1:length(taxa_gps),
                     labels = levels(mtxplot_df$tx1)) +
  scale_y_continuous(breaks = 1:length(taxa_gps),
                     labels = levels(mtxplot_df$tx2)) +
  coord_fixed() +
  scale_fill_viridis_d() +
  labs(title = sprintf('Taxa impact co-occurrence'))

ggsave(here('figs/taxa_fcol_impact_cooccur.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('figs/taxa_fcol_impact_cooccur.png'))
```

```{r map for impacted taxa count}

tx_str_df <- parallel::mclapply( # tx <- taxa_gps[1]
  taxa_gps, FUN = function(tx) {
    df <- flatten_impacts(tx, 'all', thresh = .25)
  }, mc.cores = 9) %>%
  bind_rows() %>%
  dt_join(ocean_a_df, by = 'cell_id', type = 'left')
  
taxa_map_df <- tx_str_df %>%
  group_by(cell_id) %>%
  summarize(n_tx = n())

taxa_map <- map_to_rast(taxa_map_df, cell_val = 'n_tx')
plot(taxa_map,
     axes = F, col = c(hcl.colors(n = 9)),
     main = sprintf('# of taxa impacted'))

writeRaster(taxa_map, here('_output/rasters/n_impacted_taxa_map.tif'), overwrite = TRUE)

```

## Examine high co-occurrence

``` {r look at ratios of co-occurrence}

cooccur_df_base <- read_csv(here('_output/taxa_pairwise_results.csv')) %>%
  group_by(tx1, str) %>%
  mutate(a_max = max(area_km2, na.rm = TRUE),
         cooccur = area_km2 / a_max) %>%
  ungroup()

cooccur_df <- cooccur_df_base %>%
  filter(tx1 != tx2) %>%
  filter(area_km2 > 1e6) %>%
  filter(cooccur > .6)

```

## Map of taxa presence (count)

Similar to species richness, for this comparison we want to know taxonomic richness.  Select the spp in the taxon, pull in range maps, sum up, flatten, 

``` {r create taxa richness map}

spp_incl <- get_incl_spp()

cell_id_rast <- raster(here('_spatial/cell_id_mol.tif'))
ocean_a_rast <- raster(here('_spatial/ocean_area_mol.tif'))

taxa_rich_mapfile <- here('_output/rasters/n_taxa_map.tif')

if(!file.exists(taxa_rich_mapfile) | reload) {
  
  spp_range_dir <- file.path(dir_bd_anx, 'spp_rasts_mol_2020')
  
  taxa_map_list <- vector('list', length = length(taxa_gps))
  for(i in seq_along(taxa_gps)) {
    # i <- 2
    taxa_gp <- taxa_gps[i]
    spp_ids_taxa <- spp_incl %>%
      filter(taxon == taxa_gp) %>%
      .$iucn_sid %>%
      unique()
    
    map_list <- parallel::mclapply(spp_ids_taxa, mc.cores = 12,
      FUN = function(id) {
        # id <- spp_ids_taxa[1]
        spp_f <- file.path(spp_range_dir, sprintf('iucn_sid_%s.csv', id))
        spp_df <- read_csv(spp_f, col_types = 'ii') %>%
          mutate(iucn_sid = id) %>%
          mutate(present = (presence != 5) & !is.na(presence))
      })
    map_df <- bind_rows(map_list)
    map_taxa_df <- map_df %>%
      group_by(cell_id) %>%
      summarize(present = any(present))
    taxa_map_list[[i]] <- map_to_rast(map_taxa_df, cell_val = 'present')
  }
  
  taxa_map_stack <- stack(taxa_map_list)
  taxa_rich_rast <- raster::calc(taxa_map_stack, 
                                fun = sum, na.rm = TRUE) %>%
    mask(ocean_a_rast)
  
  writeRaster(taxa_rich_rast, taxa_rich_mapfile, overwrite = TRUE)
}

taxa_rich_rast <- raster(taxa_rich_mapfile)
plot(taxa_rich_rast, 
     axes = F, col = hcl.colors(n = 20),
     main = 'Taxa richness')

taxa_impact_rast <- raster(here('_output/rasters/n_impacted_taxa_map.tif'))

taxa_prop_impact <- taxa_impac
```
